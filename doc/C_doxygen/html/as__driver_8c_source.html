<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASTERICS - A framework for image and video processing on FPGAs: as_driver.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ASTERICS - A framework for image and video processing on FPGAs
   </div>
   <div id="projectbrief">ASTERICS Documentation - Software Library, Drivers and Linux Kernel Driver</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('as__driver_8c_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">as_driver.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="as__driver_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*--------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">--  This file is part of the ASTERICS Framework and the VEARS core.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">--  (C) 2020 Hochschule Augsburg, University of Applied Sciences</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">----------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">--</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">-- Company:        University of Applied Sciences, Augsburg, Germany</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">-- Author:         Alexander Zoellner</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">--                 Patrick Zacharias</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">--</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">----------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">--  This program is free software: you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">--  it under the terms of the GNU Lesser General Public License as published by</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">--  the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">--  (at your option) any later version.</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">--</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">--  This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">--  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">--  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">--  GNU Lesser General Public License for more details.</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">--</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">--  You should have received a copy of the GNU Lesser General Public License</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">--  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">----------------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">--! @file       as_driver.c</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">--! @brief      ASTERICS linux device driver for performing general register IO</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">--              and memory data transfers.</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">--------------------------------------------------------------------------------*/</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160; </div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">/* Asterics header files */</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="as__driver_8h.html">as_driver.h</a>&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &lt;asm/io.h&gt;</span>          <span class="comment">/* ioread, -write */</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;linux/device.h&gt;</span>    <span class="comment">/* device creation, memory regions, etc. */</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &lt;linux/fs.h&gt;</span>        <span class="comment">/* file operations */</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &lt;linux/interrupt.h&gt;</span> <span class="comment">/* interrupt */</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;linux/irq.h&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;linux/irqdomain.h&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;linux/mm.h&gt;</span>     <span class="comment">/* mmap */</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;linux/module.h&gt;</span> <span class="comment">/* module (de)initialization */</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;linux/platform_device.h&gt;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="as__buffer_8h.html">as_buffer.h</a>&quot;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="as__i2c__driver_8h.html">as_i2c_driver.h</a>&quot;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="as__memio_8h.html">as_memio.h</a>&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="as__reader__writer_8h.html">as_reader_writer.h</a>&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="as__cache_8h.html">as_cache.h</a>&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno"><a class="line" href="group__as__driver.html#gae4c0dfec5aaaf56d45c4d0b4cdf82c30">   58</a></span>&#160;<a class="code" href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a> <a class="code" href="group__as__driver.html#gae4c0dfec5aaaf56d45c4d0b4cdf82c30">timer_shutdown</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">/* Forward declaration; Not static because file operations are overwritten */</span></div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="group__as__driver.html#gaf7d21502066d9cb1cb8a5ab206567bef">   60</a></span>&#160;<span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#gaf7d21502066d9cb1cb8a5ab206567bef">as_mmap_fops</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga99709eae761dae64ad77a24c15a99021">   61</a></span>&#160;<span class="keyword">struct </span>device *<a class="code" href="group__as__driver.html#ga99709eae761dae64ad77a24c15a99021">asterics_device</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">   64</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>timer_list <a class="code" href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">interrupt_timer</a>;</div>
<div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">   66</a></span>&#160;<span class="keyword">static</span> dev_t <a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">/* Global variable for the device class */</span></div>
<div class="line"><a name="l00068"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">   68</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>class *<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">/* Number of devices currently in use */</span></div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">   70</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a> = 0;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">/* Forward declaration */</span></div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="group__as__driver.html#gaf539da46951af9e73b1ab080e379655e">   72</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#gaf539da46951af9e73b1ab080e379655e">as_regio_fops</a>;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">/* Forward declaration */</span></div>
<div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="group__as__driver.html#gaeb950efba23d7cc1f5eca59ff463f329">   74</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#gaeb950efba23d7cc1f5eca59ff463f329">as_i2c_fops</a>;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">/* Forward declaration */</span></div>
<div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga76fddcf4f49879e23eb70265c2b7f043">   76</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#ga76fddcf4f49879e23eb70265c2b7f043">as_memio_fops</a>;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">/* Set pointers of device to NULL and disable interrupt handling for memio */</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keywordtype">void</span> <a class="code" href="group__as__driver.html#ga31acf76a64c66c9d65ea0ef597fb1713">set_device_defaults</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160; </div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">/* Array containing the asterics devices */</span></div>
<div class="line"><a name="l00083"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">   83</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structdevice__data__t.html">device_data_t</a> <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a>];</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">/* Work item for the shared work queue to be scheduled by the interrupt handler */</span></div>
<div class="line"><a name="l00086"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga79966fb00f8c4921b4d8c5ccc1f75515">   86</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>work_struct <a class="code" href="group__as__driver.html#ga79966fb00f8c4921b4d8c5ccc1f75515">timer_wq</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">/* The task to be executed by the work queue */</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="keywordtype">void</span> <a class="code" href="group__as__driver.html#ga29c05adf56c85ad4a2fd61bc9dcb4626">data_transfer_update_task</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> arg);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">as_mmap_wait_for_completion</a>(<span class="keywordtype">int</span> as_mmap_index);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">/* Calculate the exponent to the base of 2 for a given number ( used for obtaining the order for __get_free_pages() )*/</span></div>
<div class="line"><a name="l00093"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga7039cf09cbd9c685b8b6f35a5828e8f2">   93</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="group__as__driver.html#ga7039cf09cbd9c685b8b6f35a5828e8f2">log2_ceil</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> size) {</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> t[6] = {0xFFFFFFFF00000000ull, 0x00000000FFFF0000ull, 0x000000000000FF00ull,</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                                          0x00000000000000F0ull, 0x000000000000000Cull, 0x0000000000000002ull};</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordtype">int</span> order = (((size &amp; (size - 1)) == 0) ? 0 : 1);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordtype">int</span> j = 32;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160; </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keywordtype">int</span> k = (((size &amp; t[i]) == 0) ? 0 : j);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    order += k;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    size &gt;&gt;= k;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    j &gt;&gt;= 1;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  }</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="keywordflow">return</span> order;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;}</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">/* This function is used to set the default parameters for the currently initialized device */</span></div>
<div class="line"><a name="l00112"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga31acf76a64c66c9d65ea0ef597fb1713">  112</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="group__as__driver.html#ga31acf76a64c66c9d65ea0ef597fb1713">set_device_defaults</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index) {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[index].<a class="code" href="structdevice__data__t.html#a871978a813f8a7e7b9f32127faaf2087">req_mem_region_name</a> = NULL;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[index].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a> = NULL;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[index].<a class="code" href="structdevice__data__t.html#a4aeadbb57d7fd393d5c22b36701049a2">memio_file</a> = NULL;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  atomic_set(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[index].busy, 1);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[index].<a class="code" href="structdevice__data__t.html#a754768ccb8ac91c85bd514842ef6a15c">register_intr</a> = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[index].<a class="code" href="structdevice__data__t.html#ae274832088a2c1f08760d1f0d07a05e3">memio_active</a> = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;}</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">/*************************** HW Interrupts ****************************/</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga63672183e1e96c3e415d84daef8616a7">  124</a></span>&#160;<span class="keyword">static</span> irqreturn_t <a class="code" href="group__as__driver.html#ga63672183e1e96c3e415d84daef8616a7">as_handle_irq</a>(<span class="keywordtype">int</span> irq, <span class="keywordtype">void</span> *arg) {</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <a class="code" href="group__as__driver.html#ga29c05adf56c85ad4a2fd61bc9dcb4626">data_transfer_update_task</a>(0);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <span class="keywordflow">return</span> IRQ_HANDLED;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;}</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">/******************* Ctrl device **************************************/</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="group__ctrl__file__ops.html#gae869fa3bd595179fcf2a22ff931aee9c">  137</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="group__ctrl__file__ops.html#gae869fa3bd595179fcf2a22ff931aee9c">as_control_ioctl</a>(<span class="keyword">struct</span> file *f, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ioctl_num, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ioctl_param) {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <a class="code" href="structas__ctrl__params__t.html">as_ctrl_params_t</a> as_ctrl_params;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordtype">int</span> device_index;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <a class="code" href="group__asterics__support.html#gae835612a0b6b8ecc68e1487ffaff8fec">as_hardware_address_t</a> addr;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keywordtype">int</span> ret_val = 0;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[0].access_lock);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="keywordflow">if</span> (ioctl_num != <a class="code" href="as__linux__kernel__if_8h.html#a118349ea2cb36ff748d3712ef24cdeed">CALLED_FROM_KERNEL</a>) {</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span> (copy_from_user(&amp;as_ctrl_params, (<span class="keywordtype">void</span> *)ioctl_param, <span class="keyword">sizeof</span>(<a class="code" href="structas__ctrl__params__t.html">as_ctrl_params_t</a>)) != 0) {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;copy_from_user in as_control_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      <span class="keywordflow">return</span> ret_val = -1;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a0ad47ba0c626bdb9e33c3c71c8be3260">cmd</a> = ((<a class="code" href="structas__ctrl__params__t.html">as_ctrl_params_t</a> *)ioctl_param)-&gt;cmd;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    memcpy(&amp;as_ctrl_params, (<span class="keywordtype">void</span> *)ioctl_param, <span class="keyword">sizeof</span>(<a class="code" href="structas__ctrl__params__t.html">as_ctrl_params_t</a>));</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">if</span> (as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a0ad47ba0c626bdb9e33c3c71c8be3260">cmd</a> == <a class="code" href="as__linux__kernel__if_8h.html#a2a280719ce4bfe5b91004ba829123ec1">CMD_CREATE_DEVICE</a> || as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a0ad47ba0c626bdb9e33c3c71c8be3260">cmd</a> == <a class="code" href="as__linux__kernel__if_8h.html#a2668b791ab3218be20407fc694037087">CMD_REMOVE_DEVICE</a>) {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      strcpy(as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a3237bc897f05416ea63d14ae73030475">name</a>, ((<a class="code" href="structas__ctrl__params__t.html">as_ctrl_params_t</a> *)ioctl_param)-&gt;device.name);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    }</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  }</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordflow">switch</span> (as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a0ad47ba0c626bdb9e33c3c71c8be3260">cmd</a>) {</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a2a280719ce4bfe5b91004ba829123ec1">CMD_CREATE_DEVICE</a>:</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a> &gt;= <a class="code" href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a>) {</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Maximum number of devices reached. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        ret_val = -EUSERS;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="comment">/* Set pointer to NULL and variables to 0 */</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <a class="code" href="group__as__driver.html#ga31acf76a64c66c9d65ea0ef597fb1713">set_device_defaults</a>(<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160; </div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      <span class="keywordflow">switch</span> (as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a154d1eb426906bfcb3dc2fefa3144a0b">type</a>) {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;          <span class="comment">/* link file operations with device type... */</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96a5aabcbd88523677d66192b6a07205c7c">DEV_TYPE_REGIO</a>:</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;          <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Creating DEV_TYPE_REGIO\n&quot;</span>);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a69146f72ec71cb7494db74b14cd4b472">fops</a> = &amp;<a class="code" href="group__as__driver.html#gaf539da46951af9e73b1ab080e379655e">as_regio_fops</a>;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a871978a813f8a7e7b9f32127faaf2087">req_mem_region_name</a> = <span class="stringliteral">&quot;as_regio&quot;</span>;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96ada6ff6022a9eebd4e8356b001435b5e4">DEV_TYPE_I2C</a>:</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;          <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Creating DEV_TYPE_I2C\n&quot;</span>);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a69146f72ec71cb7494db74b14cd4b472">fops</a> = &amp;<a class="code" href="group__as__driver.html#gaeb950efba23d7cc1f5eca59ff463f329">as_i2c_fops</a>;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a871978a813f8a7e7b9f32127faaf2087">req_mem_region_name</a> = <span class="stringliteral">&quot;as_iic&quot;</span>;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96af7ff0936c190efe7bda231e679a5bdb2">DEV_TYPE_MEMIO</a>:</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;          <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Creating DEV_TYPE_MEMIO\n&quot;</span>);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a69146f72ec71cb7494db74b14cd4b472">fops</a> = &amp;<a class="code" href="group__as__driver.html#ga76fddcf4f49879e23eb70265c2b7f043">as_memio_fops</a>;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96ad81ff9d53cc04f7e021deb1d266f6247">DEV_TYPE_MMAP</a>:</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;          <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Creating DEV_TYPE_MMAP\n&quot;</span>);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a69146f72ec71cb7494db74b14cd4b472">fops</a> = &amp;<a class="code" href="group__as__driver.html#gaf7d21502066d9cb1cb8a5ab206567bef">as_mmap_fops</a>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;          ret_val = -EINVAL;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;          <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Invalid DEV_TYPE provided\n&quot;</span>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;          <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160; </div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      <span class="comment">/* Adopt device flags for open */</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#aa4368c0149318650e1d18445114ce703">flags</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a132e36b09251b55e23299b417f50282e">flags</a>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="comment">/* Adopt bit width of the memory interface */</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a35b185c1012d4209fa0674a77227ba61">interface_width</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a97402e93c9b06ea123bacc0b50370da4">interface_width</a>;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="comment">/* Adopt cache management */</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#ad3fa6148fdb2d34dc3f25020e8d1da08">manage_cache</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a696efea6ea63d2a5379323ad7156e803">manage_cache</a>;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="comment">/* Adopt data unit configuration */</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#afaa0e2c3e77e2a5084bffdc6e715daf5">support_data_unit</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#aa3b6e2f44d2e8cda3ca75c5d6c871b23">support_data_unit</a>;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      <span class="comment">/* create device */</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#abd2ad4e48be157680906ced537a4b54f">address_range_size</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      cdev_init(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].cdev, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].fops); <span class="comment">/* cdev_init has no return value */</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;      <span class="comment">/* Devices with no region name (memio, mmap) */</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].req_mem_region_name == NULL) {</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#afb85a1fffb7a72d85f59475a3e9bc384">hw_module_addr</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Set HW Module Addr to: %x\n&quot;</span>, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].hw_module_addr);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">if</span> (as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a154d1eb426906bfcb3dc2fefa3144a0b">type</a> == <a class="code" href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96ad81ff9d53cc04f7e021deb1d266f6247">DEV_TYPE_MMAP</a>) {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a> = <a class="code" href="group__asterics__support.html#ga9b562fe5abd06406020981c2f19bcc0c">as_malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structmmap__info.html">mmap_info_t</a>));</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;          <span class="keywordflow">if</span> (!<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].mmap) {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            ret_val = -ENOMEM;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;          }</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aae91c16cbc39d3e7f8a3687f9962590a">size</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;          <a class="code" href="structas__buffer__config__s.html">as_buffer_config_t</a> config;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;          config.<a class="code" href="structas__buffer__config__s.html#aef125ce0b78aa131ba79cd49fc55a886">size</a> = as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;          config.<a class="code" href="structas__buffer__config__s.html#a725038e92e75e1865d74e18ad3840b82">type</a> = <a class="code" href="group__as__buffer.html#gga618740c22dd077a5e0744a61e9d448a8a1eb4bba19a14ef4aaad528a39cdafa8b">AS_BUFFER_KERN_MEM</a>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">buffer</a> = <a class="code" href="group__as__buffer.html#ga90f980b27c24955418f94f617402c7e7">as_buffer_obj_create</a>(&amp;config);</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].mmap-&gt;buffer == NULL) {</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;            <a class="code" href="group__asterics__support.html#ga3a2ba9ffa2388da78d024646e73441ff">as_free</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].mmap);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;            ret_val = -ENOMEM;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;          }</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;          <span class="comment">/* Setup wait queue for sleeping */</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;          init_waitqueue_head(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].wait);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;          <span class="comment">/* Set condition variable to 0 (is set to 1 by interrupt routine) */</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a024a37217850ca62924915ae058d50c1">wake_up_cond</a> = 0;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        }</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      }</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      <span class="comment">/* Device which needs a named memory region (iic, regio_global) */</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">if</span> (NULL == (request_mem_region(as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>,</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                                        <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a871978a813f8a7e7b9f32127faaf2087">req_mem_region_name</a>))) {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;          <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Kernel function request_mem_region failed. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;          device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>) + <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>));</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;          ret_val = -1;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;          <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="keywordflow">if</span> (NULL == (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].baseaddress_virt = ioremap(as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>))) {</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;          <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Kernel function ioremap failed. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;          release_mem_region(as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;          device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>) + <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>));</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;          ret_val = -1;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;          <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        }</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#adc4105db9303ffcacb093b72c8bbe981">offset</a> = (resource_size_t)<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].baseaddress_virt - as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Physical Base Addr: %x for regio device\n&quot;</span>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Virtual Base Addr:  %x for regio device\n&quot;</span>, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].baseaddress_virt);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Calculated offset:  %x for regio device\n&quot;</span>, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].offset);</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;      }</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      <span class="keywordflow">if</span> (cdev_add(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].cdev, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>) + <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>), 1) == -1) {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Kernel function cdev_add failed. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="comment">/* TBD: differenciate between memiodevice and regdevice */</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        iounmap(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].baseaddress_virt);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        release_mem_region(as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>) + <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>));</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        ret_val = -1;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <span class="keywordflow">goto</span> control_exit;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;      }</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">access_lock</a> = <a class="code" href="group__asterics__support.html#ga5356d69ee6d0c515fddf95b1ee37712c">as_mutex_new</a>();</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;      <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Device %s created sucessfully at address 0x%x with range: 0x%x \n&quot;</span>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a3237bc897f05416ea63d14ae73030475">name</a>, as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">address</a>,</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;              as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">device</a>.<a class="code" href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">address_range_size</a>);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>++;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a2668b791ab3218be20407fc694037087">CMD_REMOVE_DEVICE</a>:</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      <span class="comment">/* Remove every device except the control device (which is required for creating new devices) */</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      <span class="keywordflow">for</span> (device_index = 1; device_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; device_index++) {</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        cdev_del(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].cdev);</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        addr = (<a class="code" href="group__asterics__support.html#gae835612a0b6b8ecc68e1487ffaff8fec">as_hardware_address_t</a>)(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].baseaddress_virt - <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].offset);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].req_mem_region_name != NULL) {</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;          iounmap(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].baseaddress_virt);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;          release_mem_region(addr, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].address_range_size);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        }</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].mmap != NULL) {</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;          <a class="code" href="group__as__buffer.html#ga24266b1c24e9679a68088a917f78ecf8">as_buffer_obj_destroy</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].mmap-&gt;buffer);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;          <a class="code" href="group__asterics__support.html#ga3a2ba9ffa2388da78d024646e73441ff">as_free</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].mmap);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <a class="code" href="group__asterics__support.html#ga57df9331011244df186e877459857341">as_mutex_del</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].access_lock);</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>) + device_index));</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      }</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a> = 1;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a00080b87bc47ff7434b2951168b870cb">CMD_CREATE_BUFFER</a>: {</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;      <a class="code" href="group__as__buffer.html#ga5eacf8741d14c77878f0aed49317c11c">as_buffer_obj_handle_t</a> object_handle;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;      <a class="code" href="structas__buffer__obj__s.html">as_buffer_obj_t</a> *object;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;      <a class="code" href="structas__buffer__config__s.html">as_buffer_config_t</a> *config;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160; </div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      config = &amp;as_ctrl_params.<a class="code" href="structas__ctrl__params__t.html#adf51881e8a664e0749ec03346de3cc4b">buffer</a>.<a class="code" href="unionbuffer__info__t.html#a292ff81808489b043da596bb6e4068ad">config</a>;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      <span class="keywordtype">object</span> = <a class="code" href="group__as__buffer.html#ga90f980b27c24955418f94f617402c7e7">as_buffer_obj_create</a>(config);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="keywordflow">if</span> (!<span class="keywordtype">object</span>) {</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Unable to create buffer object\n&quot;</span>);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      }</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;      object_handle = <a class="code" href="group__as__buffer.html#gaae07f36c8697636591c86ec375de82c8">as_buffer_obj_ptr_to_handle</a>(<span class="keywordtype">object</span>);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      ((<a class="code" href="structas__ctrl__params__t.html">as_ctrl_params_t</a> *)ioctl_param)-&gt;buffer.object = object_handle;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    }</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;      <a class="code" href="group__asterics__support.html#gac1620201206b65f8e52f1f2c9cecd49c">AS_WARNING</a>(<span class="stringliteral">&quot;Undefined parameter in as_control_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; </div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Initialized devices: %i\n&quot;</span>, <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>);</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160; </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;control_exit:</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;control ioctl returns with %d\n&quot;</span>, ret_val);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[0].access_lock);</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <span class="keywordflow">return</span> ret_val;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;}</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">/******************* Register IO (regio) ******************************/</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160; </div>
<div class="line"><a name="l00326"></a><span class="lineno"><a class="line" href="group__regio__file__ops.html#gaf8e5004303614b224621b34e965c510a">  326</a></span>&#160;<span class="keywordtype">long</span> <a class="code" href="group__regio__file__ops.html#gaf8e5004303614b224621b34e965c510a">as_regio_ioctl</a>(<span class="keyword">struct</span> file *filp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ioctl_num, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ioctl_param) {</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  uint32_t val;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  ptrdiff_t regio_offset = 0;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  <a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a> as_regio_params;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  <span class="keywordtype">int</span> device_index = 0;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  <span class="comment">/* Choose the appropriate method for accessing the fields of the ioctl_param structure */</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordflow">if</span> (ioctl_num != <a class="code" href="as__linux__kernel__if_8h.html#a118349ea2cb36ff748d3712ef24cdeed">CALLED_FROM_KERNEL</a>) {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordflow">if</span> (copy_from_user(&amp;as_regio_params, (<span class="keywordtype">void</span> *)ioctl_param, <span class="keyword">sizeof</span>(as_regio_params)) != 0) {</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;copy_from_user in as_regio_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;      <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    }</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a516725593a41c106a236205a180dd4cf">cmd</a> = (*(<a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a> *)ioctl_param).cmd;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">address</a> = (*(<a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a> *)ioctl_param).address;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a43dfb50290e46dc47bb21f06231f19c2">value</a> = (*(<a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a> *)ioctl_param).value;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  }</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160; </div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keywordflow">for</span> (device_index = 0; device_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; device_index++) {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="comment">/* Find out which module was called, this version allows only one global regio device containing the entire ASTERICS address space */</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment">/* since as_reg_read and as_reg_write function calls do not deliver a file pointer */</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].fops == &amp;<a class="code" href="group__as__driver.html#gaf539da46951af9e73b1ab080e379655e">as_regio_fops</a>) {</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;      <span class="comment">/* Then determine offset */</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      regio_offset = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#adc4105db9303ffcacb093b72c8bbe981">offset</a>;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  }</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="comment">/* Calculate kernel virtual address and access */</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordflow">switch</span> (as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a516725593a41c106a236205a180dd4cf">cmd</a>) {</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a4b19332dd52cdd54cd68c3c7e9ccec06">AS_IOCTL_CMD_READ</a>:</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      val = ioread32((<span class="keyword">const</span> <span class="keyword">volatile</span> <a class="code" href="group__asterics__support.html#ga0514d205dfb3e4f09e272b7a45d74889">as_kernel_address_t</a>)(as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">address</a> + regio_offset));</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      <span class="keywordflow">return</span> val;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a6d0a7f3cdf5cc8d2522d12432e5dc8c4">AS_IOCTL_CMD_WRITE</a>:</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      iowrite32(as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a43dfb50290e46dc47bb21f06231f19c2">value</a>, (<span class="keyword">volatile</span> <a class="code" href="group__asterics__support.html#ga0514d205dfb3e4f09e272b7a45d74889">as_kernel_address_t</a>)(as_regio_params.<a class="code" href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">address</a> + regio_offset));</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      <a class="code" href="group__asterics__support.html#gac1620201206b65f8e52f1f2c9cecd49c">AS_WARNING</a>(<span class="stringliteral">&quot;undefined parameter in as_regio_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  }</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;}</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">/****************************** memio *********************************/</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160; </div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment"> * Transfers data between hardware and software using the memio module</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment"> * provided by the ASTERICS framework.</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment"> * A single memio device is either associated with a as_memreader (write)</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment"> * or as_memwriter (read) and therefore supports only one direction at</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment"> * a time.</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160; </div>
<div class="line"><a name="l00388"></a><span class="lineno"><a class="line" href="group__memio__file__ops.html#gab0cee6094e9d25645dcab0b9df045467">  388</a></span>&#160;<span class="keywordtype">long</span> <a class="code" href="group__memio__file__ops.html#gab0cee6094e9d25645dcab0b9df045467">driver_as_memio_ioctl</a>(<span class="keyword">struct</span> file *filp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ioctl_num, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ioctl_param) {</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keyword">struct </span><a class="code" href="structdevice__data__t.html">device_data_t</a> *dev = filp-&gt;private_data;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordflow">if</span> (dev != NULL) {</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordflow">if</span> (((*dev).memio_active)) { <span class="comment">/* Check if memio device is open */</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      <a class="code" href="as__memio_8c.html#a2d1779f68606dd78a78a331a6c261a43">as_memio_hw_update</a>((*dev).memio_file);</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    } <span class="keywordflow">else</span> { <span class="comment">/* Permission denied since device is not open */</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      <span class="keywordflow">return</span> -EPERM;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  } <span class="keywordflow">else</span> { <span class="comment">/* Device does not exist or is no memio device */</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  }</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;}</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160; </div>
<div class="line"><a name="l00403"></a><span class="lineno"><a class="line" href="group__memio__file__ops.html#ga6a581341bc6e2a1ed45c56c0fc7bcece">  403</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__memio__file__ops.html#ga6a581341bc6e2a1ed45c56c0fc7bcece">driver_as_memio_open</a>(<span class="keyword">struct</span> inode *device_file, <span class="keyword">struct</span> file *filp) {</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordtype">int</span> device_index = 0;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <a class="code" href="structas__memio__config__s.html">as_memio_config_t</a> memio_config;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160; </div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  <span class="keywordflow">for</span> (device_index = 0; device_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; device_index++) {</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#ae421cbc510f2ef8d562015d59e598f57">cdev</a>.dev == filp-&gt;f_inode-&gt;i_rdev) {</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    }</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  }</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160; </div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">   * Test if device is already open (Only allow one open instance).</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">   * Busy is set to &quot;1&quot; upon creating the device. The following function returns &quot;1&quot; if the variable is &quot;0&quot;</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">   * after decrementing it.</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">   * The same &quot;busy&quot; flag is also used if the associated memory module is to be used for mmap!</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">   */</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordflow">if</span> (!atomic_dec_and_test(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#af3754737f794dcef3f3741e4f7244f40">busy</a>)) {</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#af3754737f794dcef3f3741e4f7244f40">busy</a>);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordflow">return</span> -EBUSY;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  }</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160; </div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="comment">/* Check if provided flags match the corresponding ones used for device creation */</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="keywordflow">if</span> ((<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#aa4368c0149318650e1d18445114ce703">flags</a> &amp; (O_RDONLY | O_WRONLY)) == (filp-&gt;f_flags &amp; (O_RDONLY | O_WRONLY))) {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="comment">/* Use memio default values (see as_memio for more details) */</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    memio_config.<a class="code" href="structas__memio__config__s.html#a655f697322308adc1823754d498f06c7">as_reader_writer_buffer_size</a> = <a class="code" href="as__memio_8h.html#acce868608c8346f4cdb9a47b193cf303">AS_MEMIO_DEFAULT_FIFO_BUFFER_SIZE</a>;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    memio_config.<a class="code" href="structas__memio__config__s.html#ad4768b062910f920a79092f81c42d482">as_reader_writer_transfer_size</a> = <a class="code" href="as__memio_8h.html#a709cbef4f931989bffb66ea3de9b4a9f">AS_MEMIO_DEFAULT_HW_TRANSFER_SIZE</a>;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    memio_config.<a class="code" href="structas__memio__config__s.html#abc270fc287118e6ea677458de8de6337">as_reader_writer_max_burst_length</a> = <a class="code" href="as__memio_8h.html#ad320e21e013ae05d9b66c50acb5bbc65">AS_MEMIO_DEFAULT_MAX_BURST_LENGTH</a>;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="comment">/* Use interface bit width provided by device tree */</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    memio_config.<a class="code" href="structas__memio__config__s.html#ac322dd709086f967b4801a4aaa1c438e">as_reader_writer_interface_width</a> = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a35b185c1012d4209fa0674a77227ba61">interface_width</a>;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    memio_config.<a class="code" href="structas__memio__config__s.html#a931fdf22611679f0bc44c39979a9ca15">manage_cache</a> = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#ad3fa6148fdb2d34dc3f25020e8d1da08">manage_cache</a>;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">/* Initialize memio */</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a4aeadbb57d7fd393d5c22b36701049a2">memio_file</a> = <a class="code" href="as__memio_8c.html#acc05505f22ed7950a0d997708c6570b4">as_memio_open</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#afb85a1fffb7a72d85f59475a3e9bc384">hw_module_addr</a>, &amp;memio_config, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#aa4368c0149318650e1d18445114ce703">flags</a>);</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a4aeadbb57d7fd393d5c22b36701049a2">memio_file</a> == NULL) {</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#af3754737f794dcef3f3741e4f7244f40">busy</a>);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;on memio open: Given flags do not match the device\n&quot;</span>);</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#af3754737f794dcef3f3741e4f7244f40">busy</a>);</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160; </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="comment">/* Check if O_NONBLOCK flag is absent */</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordflow">if</span> (!(filp-&gt;f_flags &amp; O_NONBLOCK)) {</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="comment">/* Setup wait queue for sleeping */</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    init_waitqueue_head(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#aa9dd21edb525f6096969c1dc4f7424e8">wait</a>);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="comment">/* Set condition variable to 0 (is set to 1 by interrupt routine) */</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a024a37217850ca62924915ae058d50c1">wake_up_cond</a> = 0;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  }</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="comment">/* Store device data into private area of file pointer to avoid having to search for the device again */</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  filp-&gt;private_data = &amp;(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index]);</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="comment">/* Tell interrupt routine that the device may now be served */</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#ae274832088a2c1f08760d1f0d07a05e3">memio_active</a> = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160; </div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;}</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160; </div>
<div class="line"><a name="l00462"></a><span class="lineno"><a class="line" href="group__memio__file__ops.html#gacbc077ab5c70f951062f1a7bbd311957">  462</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__memio__file__ops.html#gacbc077ab5c70f951062f1a7bbd311957">driver_as_memio_close</a>(<span class="keyword">struct</span> inode *device_file, <span class="keyword">struct</span> file *filp) {</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keyword">struct </span><a class="code" href="structdevice__data__t.html">device_data_t</a> *dev = filp-&gt;private_data;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="comment">/* Tell interrupt routine that this device is shutting down */</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  (*dev).<a class="code" href="structdevice__data__t.html#ae274832088a2c1f08760d1f0d07a05e3">memio_active</a> = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="comment">/* Disable interrupt requests */</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  (*dev).register_intr = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="comment">/* Close memio instance */</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <a class="code" href="as__memio_8c.html#afc6dfd178448a82b4761ba4c5c0ae368">as_memio_close</a>((*dev).memio_file);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="comment">/* Set device to non-busy */</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;  atomic_inc(&amp;(*dev).busy);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160; </div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;}</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160; </div>
<div class="line"><a name="l00487"></a><span class="lineno"><a class="line" href="group__memio__file__ops.html#gabc26947002eedee4c4557faff325074e">  487</a></span>&#160;<span class="keyword">static</span> ssize_t <a class="code" href="group__memio__file__ops.html#gabc26947002eedee4c4557faff325074e">driver_as_memio_read</a>(<span class="keyword">struct</span> file *filp, <span class="keywordtype">char</span> __user *buffer, <span class="keywordtype">size_t</span> count, loff_t *offp) {</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  int32_t error = 0;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  ssize_t bytes_read = 0;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  uint32_t bytes_copied = 0;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  uint32_t time_out_counter = 0;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  <span class="keyword">struct </span><a class="code" href="structdevice__data__t.html">device_data_t</a> *dev = filp-&gt;private_data;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160; </div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="comment">/* Lock to prevent multiple reads at once */</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>((*dev).access_lock);</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="comment">/* Check if read is supported by this device, i.e. it refers to a as_memwriter */</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordflow">if</span> (!filp-&gt;f_flags &amp; O_RDONLY) {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;on memio read: Not supported for this device (uses as_memwriter)\n&quot;</span>);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="comment">/* Set appropriate error */</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    error = -EBADF;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">goto</span> read_out;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;  }</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160; </div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="comment">/* Read as many data as currently possible from memio buffer and return immediately */</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="keywordflow">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) {</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    bytes_copied = <a class="code" href="as__memio_8c.html#ae26886688375b0c299ac4ce257ce92f5">as_memio_read</a>(dev-&gt;<a class="code" href="structdevice__data__t.html#a4aeadbb57d7fd393d5c22b36701049a2">memio_file</a>, buffer, count);</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keywordflow">goto</span> read_out;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160; </div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;read_retry:</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  time_out_counter++;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160; </div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  <span class="comment">/* Read all data from memio buffer, sleep if necessary */</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  (*dev).wake_up_cond = 0;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  bytes_read = <a class="code" href="as__memio_8c.html#ae26886688375b0c299ac4ce257ce92f5">as_memio_read</a>(dev-&gt;<a class="code" href="structdevice__data__t.html#a4aeadbb57d7fd393d5c22b36701049a2">memio_file</a>, buffer + bytes_copied, count - bytes_copied);</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  <span class="comment">/* If sucessfully read */</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="keywordflow">if</span> (bytes_read &gt;= 0) {</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    bytes_copied += bytes_read;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    error = 0;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bytes_read &lt; 0) {</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    error = bytes_read;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="comment">/* Sleep if there is still data remaining */</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <span class="keywordflow">if</span> (bytes_copied != count) {</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="comment">/* Tell interrupt routine that this device is going to sleep */</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    (*dev).register_intr = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="comment">/* Wait for interrupt */</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    wait_event_interruptible((*dev).wait, ((*dev).wake_up_cond));</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="comment">/* No wake-up has to be performed by interrupt routine */</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    (*dev).register_intr = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="comment">/* Check if all data has been transfered */</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">if</span> (time_out_counter &lt; 1000) {</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      <span class="keywordflow">goto</span> read_retry;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;timeout in memio_read\n&quot;</span>);</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Copied %d from %d bytes\n&quot;</span>, bytes_copied, count);</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    }</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  }</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;read_out:</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>((*dev).access_lock);</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160; </div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="comment">/* Check if an error occured, otherwise return the transferred number of bytes */</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  <span class="keywordflow">return</span> (error != 0) ? error : bytes_copied;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;}</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; </div>
<div class="line"><a name="l00558"></a><span class="lineno"><a class="line" href="group__memio__file__ops.html#gafff67fc067850f545e90c7e487f4fbce">  558</a></span>&#160;<span class="keyword">static</span> ssize_t <a class="code" href="group__memio__file__ops.html#gafff67fc067850f545e90c7e487f4fbce">driver_as_memio_write</a>(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keywordtype">char</span> __user *buffer, <span class="keywordtype">size_t</span> count, loff_t *offp) {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  int32_t error = 0;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  ssize_t bytes_written = 0;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  ssize_t bytes_copied = 0;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  uint32_t time_out_counter = 0;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="keyword">struct </span><a class="code" href="structdevice__data__t.html">device_data_t</a> *dev = filp-&gt;private_data;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="comment">/* Lock to prevent multiple writes at once */</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>((*dev).access_lock);</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Locked (write) %p\n&quot;</span>, dev-&gt;<a class="code" href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">access_lock</a>);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160; </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="comment">/* Check if write is supported by this device, i.e. it refers to a as_memreader */</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordflow">if</span> (!filp-&gt;f_flags &amp; O_WRONLY) {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;on memio read: Not supported for this device (uses as_memreader)\n&quot;</span>);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="comment">/* Set appropriate error */</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    error = -EBADF;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">goto</span> write_out;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  }</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160; </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="comment">/* Write as many data as currently possible to memio buffer and return immediately */</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="keywordflow">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) {</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    bytes_copied = (ssize_t)<a class="code" href="as__memio_8c.html#a1d306d68268eb68703b595cb416c5024">as_memio_write</a>((*dev).memio_file, buffer, count);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordflow">goto</span> write_out;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  }</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160; </div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;write_retry:</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160; </div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  time_out_counter++;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160; </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="comment">/* Write all data to memio buffer, sleep if necessary */</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  (*dev).wake_up_cond = 0;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  bytes_written = <a class="code" href="as__memio_8c.html#a1d306d68268eb68703b595cb416c5024">as_memio_write</a>((*dev).memio_file, buffer + bytes_copied, count - bytes_copied);</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="comment">/* If sucessfully read */</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordflow">if</span> (bytes_written &gt;= 0) {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    bytes_copied += bytes_written;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    error = 0;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bytes_written &lt; 0) {</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    error = bytes_written;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  }</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="comment">/* Sleep if there is still data remaining */</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="keywordflow">if</span> (bytes_copied != count) {</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="comment">/* Tell interrupt routine that this device is going to sleep */</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    (*dev).register_intr = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="comment">/* Wait for interrupt */</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    wait_event_interruptible((*dev).wait, ((*dev).wake_up_cond));</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="comment">/* No wake-up has to be performed by interrupt routine */</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    (*dev).register_intr = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="comment">/* Check if all data has been transfered */</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <span class="keywordflow">if</span> (time_out_counter &lt; 100) {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="keywordflow">goto</span> write_retry;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;      <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;timeout in memio_write\n&quot;</span>);</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Copied %d from %d bytes\n&quot;</span>, bytes_copied, count);</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    }</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  }</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;write_out:</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160; </div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>((*dev).access_lock);</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;UnLocked (write) %p\n&quot;</span>, dev-&gt;<a class="code" href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">access_lock</a>);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160; </div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  <span class="comment">/* Check if an error occured, otherwise return the transferred number of bytes */</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;  <span class="keywordflow">return</span> (error != 0) ? error : bytes_copied;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;}</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment">/****************************** i2c ***********************************/</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno"><a class="line" href="group__i2c__file__ops.html#gac4209ea12d9dea0d155e513bbaff4bc2">  629</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="group__i2c__file__ops.html#gac4209ea12d9dea0d155e513bbaff4bc2">as_i2c_ioctl</a>(<span class="keyword">struct</span> file *f, uint32_t ioctl_num, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ioctl_param) {</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  uint32_t val;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <a class="code" href="group__asterics__support.html#ga0514d205dfb3e4f09e272b7a45d74889">as_kernel_address_t</a> LocalAddr;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  uint32_t iic_offset = 0;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160; </div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a> as_iic_params;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160; </div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="keywordtype">int</span> device_index;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="keywordflow">if</span> (copy_from_user(&amp;as_iic_params, (<span class="keywordtype">void</span> *)ioctl_param, <span class="keyword">sizeof</span>(<a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a>)) != 0) {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;copy_from_user in as_i2c_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  }</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160; </div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  <span class="keywordflow">for</span> (device_index = 0; device_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; device_index++) {</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#ae421cbc510f2ef8d562015d59e598f57">cdev</a>.dev == f-&gt;f_inode-&gt;i_rdev) {</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <span class="comment">/* Determine offset */</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;      iic_offset = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#adc4105db9303ffcacb093b72c8bbe981">offset</a>;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    }</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  }</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  <span class="keywordflow">switch</span> (as_iic_params.<a class="code" href="structas__ioctl__params__t.html#a516725593a41c106a236205a180dd4cf">cmd</a>) {</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a4b19332dd52cdd54cd68c3c7e9ccec06">AS_IOCTL_CMD_READ</a>:</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      val = ioread32((<a class="code" href="group__asterics__support.html#ga0514d205dfb3e4f09e272b7a45d74889">as_kernel_address_t</a>)(as_iic_params.<a class="code" href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">address</a> + iic_offset));</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      <span class="keywordflow">return</span> val;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="as__linux__kernel__if_8h.html#a6d0a7f3cdf5cc8d2522d12432e5dc8c4">AS_IOCTL_CMD_WRITE</a>:</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      LocalAddr = (<a class="code" href="group__asterics__support.html#ga0514d205dfb3e4f09e272b7a45d74889">as_kernel_address_t</a>)(as_iic_params.<a class="code" href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">address</a> + iic_offset);</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      iowrite32(as_iic_params.<a class="code" href="structas__ioctl__params__t.html#a43dfb50290e46dc47bb21f06231f19c2">value</a>, LocalAddr);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      <a class="code" href="group__asterics__support.html#gac1620201206b65f8e52f1f2c9cecd49c">AS_WARNING</a>(<span class="stringliteral">&quot;undefined parameter in as_i2c_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;  }</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;}</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160; </div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment">/***************************** mmap *******************************/</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160; </div>
<div class="line"><a name="l00673"></a><span class="lineno"><a class="line" href="group__mmap__file__ops.html#ga93a1477871ee8b3e8071b60442a0ceb3">  673</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mmap__file__ops.html#ga93a1477871ee8b3e8071b60442a0ceb3">as_mmap_start_transfer</a>(<a class="code" href="group__asterics__support.html#gae835612a0b6b8ecc68e1487ffaff8fec">as_hardware_address_t</a> module_addr, <a class="code" href="structas__buffer__obj__s.html">as_buffer_obj_t</a> *buf,</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;                                  <span class="keywordtype">size_t</span> <a class="code" href="structdevice__data__t.html#adc4105db9303ffcacb093b72c8bbe981">offset</a>, <span class="keywordtype">size_t</span> count, <a class="code" href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a> is_write, <a class="code" href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a> cache_management) {</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a1aefe55cd4725a83df55059a78290281">buffer_size</a> &lt; count) {</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="comment">// AS_ERROR(&quot;Tried to transfer more bytes than available buffer size: %x\n&quot;, buf-&gt;buffer_size);</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    count = buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a1aefe55cd4725a83df55059a78290281">buffer_size</a>;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  }</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> != <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a>) {</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <a class="code" href="group__asterics__support.html#gac1620201206b65f8e52f1f2c9cecd49c">AS_WARNING</a>(<span class="stringliteral">&quot;Wrong state to start DMA transfer with\n&quot;</span>);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  }</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="comment">/* Use defaults for burst length */</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <a class="code" href="group__as__reader__writer.html#ga5c0bd52e53c8e68de80b1712c12d9a4a">as_reader_writer_init</a>(module_addr, NULL);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <a class="code" href="group__as__reader__writer.html#ga06436c5cb6a63439f2e4b7c14c71fb83">as_reader_writer_set_section_size</a>(module_addr, count);</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <a class="code" href="group__as__reader__writer.html#ga43d2f73d7d42dd5704160d4ddacfaa1e">as_reader_writer_set_section_addr</a>(module_addr, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ae95907c4fbcdd18eb4ad059419247061">buffer_baseaddr_phys</a> + <a class="code" href="structdevice__data__t.html#adc4105db9303ffcacb093b72c8bbe981">offset</a>);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  <span class="keywordflow">if</span> (!is_write) {</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a896566e6ea09c62f3d124c82170e8506">direction</a> = <a class="code" href="group__as__buffer.html#gga79d77438f1c5c83a66b218ade7beb5c6a88efb34059cd3c07368aa92a75ca2860">AS_BUFFER_DIR_FROM_DEV</a>;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;mmap start transfer from device\n&quot;</span>);</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    buf-&gt;dma_addr = <a class="code" href="as__cache_8c.html#a82dda14c005c5bd0028e5f25fad2923c">as_map_single</a>(buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a65ba4516cd1d80b097b9cd9874d635cd">buffer_baseaddr_virt</a>, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a1aefe55cd4725a83df55059a78290281">buffer_size</a>, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a896566e6ea09c62f3d124c82170e8506">direction</a>, cache_management);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <a class="code" href="group__as__reader__writer.html#ga1ef22dbd33d87de51113837dd9123c6f">as_writer_set_enable</a>(module_addr);</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <a class="code" href="group__as__reader__writer.html#ga2c3650318b12edaf3f4473fed557cc74">as_writer_set_disable_on_no_go</a>(module_addr);</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a896566e6ea09c62f3d124c82170e8506">direction</a> = <a class="code" href="group__as__buffer.html#gga79d77438f1c5c83a66b218ade7beb5c6a46f9696f7461572425be23a9bc709a4c">AS_BUFFER_DIR_TO_DEV</a>;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;mmap start transfer to device\n&quot;</span>);</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    buf-&gt;dma_addr = <a class="code" href="as__cache_8c.html#a82dda14c005c5bd0028e5f25fad2923c">as_map_single</a>(buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a65ba4516cd1d80b097b9cd9874d635cd">buffer_baseaddr_virt</a>, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a1aefe55cd4725a83df55059a78290281">buffer_size</a>, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a896566e6ea09c62f3d124c82170e8506">direction</a>, cache_management);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  }</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;  <a class="code" href="group__as__reader__writer.html#ga38bb160b6e30eb5fce6df2e4b4894fad">as_reader_writer_set_go</a>(module_addr);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a> = count;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> = <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a6a1a440627004c448361b8f493c345f7">AS_BUFFER_STATE_OWN_DEVICE</a>;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;}</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160; </div>
<div class="line"><a name="l00710"></a><span class="lineno"><a class="line" href="group__mmap__file__ops.html#ga2818d1d7a0430100ab879f5a385e849b">  710</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__mmap__file__ops.html#ga2818d1d7a0430100ab879f5a385e849b">driver_as_mmap</a>(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> vm_area_struct *vma) {</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pfn;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  <span class="keywordtype">int</span> ret_val = 0;</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;  <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; i++) {</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[i].<a class="code" href="structdevice__data__t.html#ae421cbc510f2ef8d562015d59e598f57">cdev</a>.dev == filp-&gt;f_inode-&gt;i_rdev) {</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    }</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  }</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160; </div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <span class="comment">/* Lock to prevent mapping the same area twice */</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[i].<a class="code" href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">access_lock</a>);</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160; </div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;  <span class="comment">/* Check if requested memory region is within the scope of the physical memory */</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <span class="keywordflow">if</span> ((vma-&gt;vm_end - vma-&gt;vm_start) &gt; (*<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[i].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>).size) {</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    ret_val = -ENOMEM;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">goto</span> mmap_exit;</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  }</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160; </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  <span class="comment">/* Get the page frame number for remapping the physical memory to virtual */</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  pfn = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[i].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">buffer</a>-&gt;<a class="code" href="structas__buffer__obj__s.html#ae95907c4fbcdd18eb4ad059419247061">buffer_baseaddr_phys</a> &gt;&gt; PAGE_SHIFT;</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160; </div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;  <span class="comment">/* The actual remapping */</span></div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;  <span class="keywordflow">if</span> (remap_pfn_range(vma, vma-&gt;vm_start, pfn, vma-&gt;vm_end - vma-&gt;vm_start, vma-&gt;vm_page_prot)) {</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    ret_val = -EAGAIN;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    <span class="keywordflow">goto</span> mmap_exit;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  filp-&gt;private_data = vma;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160; </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;mmap_exit:</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[i].<a class="code" href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">access_lock</a>);</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="keywordflow">return</span> ret_val;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;}</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160; </div>
<div class="line"><a name="l00749"></a><span class="lineno"><a class="line" href="group__mmap__file__ops.html#gae18f99f9774b7224e71d80209ecd0bf4">  749</a></span>&#160;<span class="keyword">static</span> ssize_t <a class="code" href="group__mmap__file__ops.html#gae18f99f9774b7224e71d80209ecd0bf4">driver_as_mmap_read</a>(<span class="keyword">struct</span> file *filp, <span class="keywordtype">char</span> __user *buffer, <span class="keywordtype">size_t</span> count, loff_t *offp) {</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="keyword">struct </span>vm_area_struct *vma = filp-&gt;private_data;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  <a class="code" href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a> memory_mod_found;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keywordtype">int</span> as_mmap_index, hw_module_index, ret_val = 0;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160; </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="comment">/* Search as_mmap module */</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordflow">for</span> (as_mmap_index = 0; as_mmap_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; as_mmap_index++) {</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].cdev.dev == filp-&gt;f_inode-&gt;i_rdev) {</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    }</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].access_lock);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160; </div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  <span class="keywordflow">if</span> (vma == NULL) {</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Memory has not been mapped. Call to mmap required!\n&quot;</span>);</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    ret_val = -EINVAL;</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  }</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160; </div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].hw_module_addr == 0) {</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Tried to read from device without configured hw_module addr\n&quot;</span>);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    ret_val = -ENODEV;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  }</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160; </div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;  memory_mod_found = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160; </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <span class="comment">/* Search hardware module */</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  <span class="keywordflow">for</span> (hw_module_index = 0; hw_module_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; hw_module_index++) {</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr == <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].hw_module_addr) {</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      memory_mod_found = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    }</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  }</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160; </div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  <span class="comment">/* The corresponding memory module is not guaranteed to exist */</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  <span class="keywordflow">if</span> (!memory_mod_found) {</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    ret_val = -ENODEV;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  }</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <span class="comment">/* Ensure buffer is big enough to hold count, if not limit count */</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)buffer + count &gt; vma-&gt;vm_end) {</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    count = vma-&gt;vm_end - (<span class="keywordtype">unsigned</span> long)buffer;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  }</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160; </div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  <span class="comment">/* Test if hardware device is already in use by memio */</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  <span class="keywordflow">if</span> (!atomic_dec_and_test(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy)) {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    ret_val = -EBUSY;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  }</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="group__as__reader__writer.html#ga8ffa108d758f416593d508d00fdbfed6">as_writer_is_sync_error</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr)) {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Tried to use MemWriter after sync error occured\n&quot;</span>);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    ret_val = -ENODEV;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  }</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160; </div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="comment">// Unless it&#39;s overwritten by the actual count</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;  ret_val = -EAGAIN;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160; </div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;  <a class="code" href="structas__buffer__obj__s.html">as_buffer_obj_t</a> *buf = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">buffer</a>;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;  <span class="comment">//AS_INFO(&quot;mmap read: up: %x, %x\n&quot;, buffer, vma-&gt;vm_start);</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160; </div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a> &amp;&amp; count &gt; 0) {</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Checking pending go for: %x\n&quot;</span>, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr);</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__reader__writer.html#gab3f2465225201507d51787478ac5955a">as_reader_writer_is_pending_go</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr) == <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>) {</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;      <span class="keywordtype">size_t</span> offset = (<span class="keywordtype">unsigned</span> long)buffer - vma-&gt;vm_start;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;      <a class="code" href="group__mmap__file__ops.html#ga93a1477871ee8b3e8071b60442a0ceb3">as_mmap_start_transfer</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr, buf, offset, count, <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>,</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                             <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].manage_cache);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Tried to start mmap transfer, faster than ASTERICS can accept commands\n&quot;</span>);</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;      atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;      <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    }</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  }</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160; </div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a6a1a440627004c448361b8f493c345f7">AS_BUFFER_STATE_OWN_DEVICE</a>) {</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment">//AS_ERROR(&quot;Checking state (read)\n&quot;);</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <a class="code" href="group__as__buffer.html#ga4be2b60d2ac888f473e52f39c9492368">as_buffer_update_state</a>(buf, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].support_data_unit, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].manage_cache);</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  }</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160; </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  <span class="keywordflow">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) {</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a8b76d66328ed9fbf4c4992153ccc8e4e">AS_BUFFER_STATE_OWN_CPU</a>) {</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;copied (read): %x\n&quot;</span>, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a>);</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;      ret_val = buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a>;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> = <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a>;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    }</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <a class="code" href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">as_mmap_wait_for_completion</a>(as_mmap_index);</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    ret_val = buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a>;</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  }</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160; </div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <span class="comment">/* Only release memory module if all data has been transfered */</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160; </div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  mmap_write_out:</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160; </div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].access_lock);</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <span class="keywordflow">return</span> ret_val;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;}</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160; </div>
<div class="line"><a name="l00856"></a><span class="lineno"><a class="line" href="group__mmap__file__ops.html#gaeea3980f5b633c4b83ff46b2efc2ea10">  856</a></span>&#160;<span class="keyword">static</span> ssize_t <a class="code" href="group__mmap__file__ops.html#gaeea3980f5b633c4b83ff46b2efc2ea10">driver_as_mmap_write</a>(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keywordtype">char</span> __user *buffer, <span class="keywordtype">size_t</span> count, loff_t *offp) {</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  <span class="keyword">struct </span>vm_area_struct *vma = filp-&gt;private_data;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  <a class="code" href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a> memory_mod_found;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  <span class="keywordtype">int</span> as_mmap_index, hw_module_index, ret_val = 0;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160; </div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;  <span class="comment">/* Search as_mmap module */</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  <span class="keywordflow">for</span> (as_mmap_index = 0; as_mmap_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; as_mmap_index++) {</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].cdev.dev == filp-&gt;f_inode-&gt;i_rdev) {</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    }</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  }</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160; </div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].access_lock);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160; </div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keywordflow">if</span> (vma == NULL) {</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Memory has not been mapped. Call to mmap required!\n&quot;</span>);</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    ret_val = -EINVAL;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160; </div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].hw_module_addr == 0) {</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Tried to read from device without configured hw_module addr\n&quot;</span>);</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    ret_val = -ENODEV;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  }</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160; </div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;  memory_mod_found = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160; </div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;  <span class="comment">/* Search hardware module */</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;  <span class="keywordflow">for</span> (hw_module_index = 0; hw_module_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; hw_module_index++) {</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr == <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].hw_module_addr) {</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;      memory_mod_found = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    }</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  }</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160; </div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;  <span class="comment">/* The corresponding memory module is not guaranteed to exist */</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;  <span class="keywordflow">if</span> (!memory_mod_found) {</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    ret_val = -ENODEV;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;  }</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160; </div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;  <span class="comment">// If this is insufficient, make sure buffer is between vm_start and vm_end</span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;  <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)buffer + count &gt; vma-&gt;vm_end) {</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    count = vma-&gt;vm_end - (<span class="keywordtype">unsigned</span> long)buffer;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;  }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160; </div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;  <span class="comment">/* Test if hardware device is already in use by memio */</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;  <span class="keywordflow">if</span> (!atomic_dec_and_test(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy)) {</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    ret_val = -EBUSY;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;  }</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160; </div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="comment">// Unless it&#39;s overwritten by the actual count</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;  ret_val = -EAGAIN;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160; </div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  <a class="code" href="structas__buffer__obj__s.html">as_buffer_obj_t</a> *buf = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">buffer</a>;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160; </div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a> &amp;&amp; count &gt; 0) {</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__reader__writer.html#gab3f2465225201507d51787478ac5955a">as_reader_writer_is_pending_go</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr) == <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>) {</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;      <span class="keywordtype">size_t</span> offset = (<span class="keywordtype">unsigned</span> long)buffer - vma-&gt;vm_start;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;      <a class="code" href="group__mmap__file__ops.html#ga93a1477871ee8b3e8071b60442a0ceb3">as_mmap_start_transfer</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr, buf, offset, count, <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>,</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                             <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].manage_cache);</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Tried to start mmap transfer, faster than ASTERICS can accept commands\n&quot;</span>);</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;      atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;      <span class="keywordflow">goto</span> mmap_write_out;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    }</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  }</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160; </div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a6a1a440627004c448361b8f493c345f7">AS_BUFFER_STATE_OWN_DEVICE</a>) {</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <a class="code" href="group__as__buffer.html#ga4be2b60d2ac888f473e52f39c9492368">as_buffer_update_state</a>(buf, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].support_data_unit, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].manage_cache);</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  }</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160; </div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  <span class="comment">// If blocking, wait here until completion</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  <span class="keywordflow">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) {</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a8b76d66328ed9fbf4c4992153ccc8e4e">AS_BUFFER_STATE_OWN_CPU</a>) {</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;copied (write): %x\n&quot;</span>, buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a>);</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;      ret_val = buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a>;</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;      buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> = <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a>;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    }</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <a class="code" href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">as_mmap_wait_for_completion</a>(as_mmap_index);</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    ret_val = buf-&gt;<a class="code" href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">transfer_size</a>;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;  }</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160; </div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="comment">/* Only release memory module if all data has been transfered */</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160; </div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  mmap_write_out:</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160; </div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].access_lock);</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <span class="keywordflow">return</span> ret_val;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;}</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160; </div>
<div class="line"><a name="l00954"></a><span class="lineno"><a class="line" href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">  954</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">as_mmap_wait_for_completion</a>(<span class="keywordtype">int</span> as_mmap_index) {</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  <a class="code" href="structas__buffer__obj__s.html">as_buffer_obj_t</a> *buf = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">buffer</a>;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a>)</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160; </div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <span class="comment">/* Tell interrupt routine that this device will need to be woken */</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a754768ccb8ac91c85bd514842ef6a15c">register_intr</a> = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160; </div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> retries = 0;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <span class="comment">/* Every time an interrupt is triggered, wake up, check if the state is appropriate */</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;  <span class="keywordflow">while</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> != <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a>) {</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> != <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a6a1a440627004c448361b8f493c345f7">AS_BUFFER_STATE_OWN_DEVICE</a>) {</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Unexpected state\n&quot;</span>);</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    }</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160; </div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a024a37217850ca62924915ae058d50c1">wake_up_cond</a> = 0;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="comment">/* Wait for interrupt */</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    wait_event_interruptible(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].wait, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].wake_up_cond);</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160; </div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    <a class="code" href="group__as__buffer.html#ga4be2b60d2ac888f473e52f39c9492368">as_buffer_update_state</a>(buf, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].hw_module_addr, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].support_data_unit, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].manage_cache);</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <span class="comment">// We don&#39;t care about the result, just set it to inactive</span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> == <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a8b76d66328ed9fbf4c4992153ccc8e4e">AS_BUFFER_STATE_OWN_CPU</a>)</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;      buf-&gt;<a class="code" href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">state</a> = <a class="code" href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a>;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160; </div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    retries++;</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="keywordflow">if</span>(retries &gt;= 1000) {</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;      <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Timeout\n&quot;</span>);</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    }</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  }</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  <span class="comment">/* No wake-up has to be performed by interrupt routine */</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a754768ccb8ac91c85bd514842ef6a15c">register_intr</a> = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;}</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160; </div>
<div class="line"><a name="l00993"></a><span class="lineno"><a class="line" href="group__mmap__file__ops.html#gab078c489a563497f4da70a9f6115dfce">  993</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="group__mmap__file__ops.html#gab078c489a563497f4da70a9f6115dfce">as_mmap_ioctl</a>(<span class="keyword">struct</span> file *filp, uint32_t ioctl_num, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ioctl_param) {</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;  <span class="keywordtype">bool</span> memory_mod_found;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordtype">int</span> as_mmap_index, hw_module_index;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a> as_mmap_params;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  uint32_t address_offset;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  <span class="keywordtype">int</span> ret_val = 0;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  <span class="keyword">struct </span>vm_area_struct *vma = filp-&gt;private_data;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160; </div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;ioctl for mmap device called\n&quot;</span>);</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  <span class="comment">/* Search as_mmap module */</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;  <span class="keywordflow">for</span> (as_mmap_index = 0; as_mmap_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; as_mmap_index++) {</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].cdev.dev == filp-&gt;f_inode-&gt;i_rdev) {</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    }</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;  }</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160; </div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <a class="code" href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].access_lock);</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160; </div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;  <span class="keywordflow">if</span> (copy_from_user(&amp;as_mmap_params, (<span class="keywordtype">void</span> *)ioctl_param, <span class="keyword">sizeof</span>(<a class="code" href="structas__ioctl__params__t.html">as_ioctl_params_t</a>)) != 0) {</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;copy_from_user in as_mmap_ioctl\n&quot;</span>);</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    ret_val = -EAGAIN;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;  }</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160; </div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  <span class="keywordflow">if</span> (vma == NULL) {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Memory has not been mapped. Call to mmap required!\n&quot;</span>);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    ret_val = -EINVAL;</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  }</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  memory_mod_found = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160; </div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  <span class="comment">/* Search hardware module */</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;  <span class="keywordflow">for</span> (hw_module_index = 0; hw_module_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; hw_module_index++) {</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <span class="comment">/* Find out which module was called */</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr == as_mmap_params.<a class="code" href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">address</a>) {</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;      memory_mod_found = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    }</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;  }</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160; </div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;  <span class="comment">/* The corresponding memory module is not guaranteed to exist */</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;  <span class="keywordflow">if</span> (!memory_mod_found) {</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    ret_val = -ENODEV;</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;  }</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160; </div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="keywordflow">if</span> (as_mmap_params.<a class="code" href="structas__ioctl__params__t.html#a516725593a41c106a236205a180dd4cf">cmd</a> == <a class="code" href="as__linux__kernel__if_8h.html#ab500ace747750a8e2beba0600a1b5e31">AS_IOCTL_CMD_MMAP_WAIT</a>) {</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <a class="code" href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">as_mmap_wait_for_completion</a>(as_mmap_index);</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;  }</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160; </div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="comment">// Else if not checking for wait</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160; </div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;  <span class="comment">/* Determine the offset within the allocated memory area for the data transfer*/</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  address_offset = (uint32_t)as_mmap_params.<a class="code" href="structas__ioctl__params__t.html#aedaff71920db4dc2701fe9be734c4c6d">user_addr_start</a>;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  if ((as_mmap_params.<a class="code" href="structas__ioctl__params__t.html#a43dfb50290e46dc47bb21f06231f19c2">value</a> + address_offset) &gt; <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aae91c16cbc39d3e7f8a3687f9962590a">size</a>) {</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;requested size is out of scope\n&quot;</span>);</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    ret_val = -EINVAL;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  }</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160; </div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="comment">/* Test if hardware device is already in use by memio */</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  <span class="keywordflow">if</span> (!atomic_dec_and_test(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy)) {</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    ret_val = -EBUSY;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  }</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160; </div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <a class="code" href="structas__buffer__obj__s.html">as_buffer_obj_t</a> *buf = <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].<a class="code" href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">mmap</a>-&gt;<a class="code" href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">buffer</a>;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="group__as__reader__writer.html#gab3f2465225201507d51787478ac5955a">as_reader_writer_is_pending_go</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr) == <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>) {</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <a class="code" href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a> is_write = (as_mmap_params.<a class="code" href="structas__ioctl__params__t.html#a516725593a41c106a236205a180dd4cf">cmd</a> == <a class="code" href="as__linux__kernel__if_8h.html#a6d0a7f3cdf5cc8d2522d12432e5dc8c4">AS_IOCTL_CMD_WRITE</a>) ? <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a> : <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <a class="code" href="group__mmap__file__ops.html#ga93a1477871ee8b3e8071b60442a0ceb3">as_mmap_start_transfer</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].hw_module_addr, buf, address_offset, as_mmap_params.<a class="code" href="structas__ioctl__params__t.html#a43dfb50290e46dc47bb21f06231f19c2">value</a>, is_write,</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                           <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].<a class="code" href="structdevice__data__t.html#ad3fa6148fdb2d34dc3f25020e8d1da08">manage_cache</a>);</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Tried to start mmap transfer, faster than ASTERICS can accept commands\n&quot;</span>);</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    ret_val = -EAGAIN;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <span class="keywordflow">goto</span> mmap_ioctl_out;</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  }</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160; </div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="comment">/* Only release memory module if all data has been transfered */</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;  atomic_inc(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[hw_module_index].busy);</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160; </div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;mmap_ioctl_out:</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  <span class="keywordflow">if</span> (ret_val &lt; 0)</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;mmap failed with: %d\n&quot;</span>, ret_val);</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160; </div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  <a class="code" href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[as_mmap_index].access_lock);</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;  <span class="keywordflow">return</span> ret_val;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;}</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="comment">/******************************* Timer ********************************/</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160; </div>
<div class="line"><a name="l01103"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga29c05adf56c85ad4a2fd61bc9dcb4626"> 1103</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="group__as__driver.html#ga29c05adf56c85ad4a2fd61bc9dcb4626">data_transfer_update_task</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> arg) {</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  <span class="keywordtype">int</span> device_index;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160; </div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;  <span class="comment">/* Loop all devices and synchronize data buffers for memio */</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="keywordflow">for</span> (device_index = 0; device_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; device_index++) {</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].fops == &amp;<a class="code" href="group__as__driver.html#ga76fddcf4f49879e23eb70265c2b7f043">as_memio_fops</a>) {       <span class="comment">/* Check for memio device */</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].memio_active)) {             <span class="comment">/* Check if memio device is open; mainly required for hw update */</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].register_intr) {            <span class="comment">/* Check if interrupts can be served; only call wake up when process is actually sleeping */</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;          <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a024a37217850ca62924915ae058d50c1">wake_up_cond</a> = 1;             <span class="comment">/* Set the wake-up condition */</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;          wake_up_interruptible(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].wait); <span class="comment">/* Wake up blocking device */</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        } </div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      }</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].fops == &amp;<a class="code" href="group__as__driver.html#gaf7d21502066d9cb1cb8a5ab206567bef">as_mmap_fops</a>) { <span class="comment">/* Check for mmap device */</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].register_intr) {              <span class="comment">/* Check if interrupts can be served; only call wake up when process is actually sleeping */</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].<a class="code" href="structdevice__data__t.html#a024a37217850ca62924915ae058d50c1">wake_up_cond</a> = 1;               <span class="comment">/* Set the wake-up condition */</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        wake_up_interruptible(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].wait);   <span class="comment">/* Wake up blocking device */</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;      }</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    }</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  }</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;}</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160; </div>
<div class="line"><a name="l01125"></a><span class="lineno"><a class="line" href="group__as__driver.html#gacbe125809cd40fef7c72c391bffe69aa"> 1125</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="group__as__driver.html#gacbe125809cd40fef7c72c391bffe69aa">timer_callback</a>(<span class="keyword">struct</span> timer_list *data) {</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;  <span class="comment">/* Trigger to run work queue which handles waking up sleeping processes */</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  schedule_work(&amp;<a class="code" href="group__as__driver.html#ga79966fb00f8c4921b4d8c5ccc1f75515">timer_wq</a>);</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160; </div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;  <span class="comment">/* Check if timer is going to shutdown due to unloading module */</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="group__as__driver.html#gae4c0dfec5aaaf56d45c4d0b4cdf82c30">timer_shutdown</a>) {</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="comment">/* Run timer again */</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    add_timer(&amp;<a class="code" href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">interrupt_timer</a>);</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;  }</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;}</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="comment">/***************************** Top-Level ******************************/</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160; </div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="comment"> * File operation structs for all device types of the driver.</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160; </div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#gaf7d21502066d9cb1cb8a5ab206567bef">as_mmap_fops</a> = {</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    .owner = THIS_MODULE,</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    .mmap = <a class="code" href="group__mmap__file__ops.html#ga2818d1d7a0430100ab879f5a385e849b">driver_as_mmap</a>,</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    .read = <a class="code" href="group__mmap__file__ops.html#gae18f99f9774b7224e71d80209ecd0bf4">driver_as_mmap_read</a>,</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    .write = <a class="code" href="group__mmap__file__ops.html#gaeea3980f5b633c4b83ff46b2efc2ea10">driver_as_mmap_write</a>,</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    .unlocked_ioctl = <a class="code" href="group__mmap__file__ops.html#gab078c489a563497f4da70a9f6115dfce">as_mmap_ioctl</a>,</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <span class="comment">// TODO: .release</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;};</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160; </div>
<div class="line"><a name="l01154"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga64923ef94173c53c95fed2b910bdc4f2"> 1154</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#ga64923ef94173c53c95fed2b910bdc4f2">as_control_fops</a> = {</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    .owner = THIS_MODULE,</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    .unlocked_ioctl = <a class="code" href="group__ctrl__file__ops.html#gae869fa3bd595179fcf2a22ff931aee9c">as_control_ioctl</a>,</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;};</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160; </div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#gaf539da46951af9e73b1ab080e379655e">as_regio_fops</a> = {</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    .owner = THIS_MODULE,</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    .unlocked_ioctl = <a class="code" href="group__regio__file__ops.html#gaf8e5004303614b224621b34e965c510a">as_regio_ioctl</a>,</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;};</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160; </div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#ga76fddcf4f49879e23eb70265c2b7f043">as_memio_fops</a> = {</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    .owner = THIS_MODULE,</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    .read = <a class="code" href="group__memio__file__ops.html#gabc26947002eedee4c4557faff325074e">driver_as_memio_read</a>,</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    .write = <a class="code" href="group__memio__file__ops.html#gafff67fc067850f545e90c7e487f4fbce">driver_as_memio_write</a>,</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    .unlocked_ioctl = <a class="code" href="group__memio__file__ops.html#gab0cee6094e9d25645dcab0b9df045467">driver_as_memio_ioctl</a>,</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    .open = <a class="code" href="group__memio__file__ops.html#ga6a581341bc6e2a1ed45c56c0fc7bcece">driver_as_memio_open</a>,</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    .release = <a class="code" href="group__memio__file__ops.html#gacbc077ab5c70f951062f1a7bbd311957">driver_as_memio_close</a>,</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;};</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160; </div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="group__as__driver.html#gaeb950efba23d7cc1f5eca59ff463f329">as_i2c_fops</a> = {</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    .owner = THIS_MODULE,</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    .unlocked_ioctl = <a class="code" href="group__i2c__file__ops.html#gac4209ea12d9dea0d155e513bbaff4bc2">as_i2c_ioctl</a>,</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;};</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160; </div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment">/**************************** Constructor *****************************/</span></div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160; </div>
<div class="line"><a name="l01189"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga6d23d0b288768770efba635a43d7f541"> 1189</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__as__driver.html#ga6d23d0b288768770efba635a43d7f541">asterics_probe</a>(<span class="keyword">struct</span> platform_device *pdev) {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  <span class="keywordtype">int</span> irq = 0;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160; </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="comment">/* Get a range of minor numbers (starting with 0) to work with */</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  <span class="keywordflow">if</span> (alloc_chrdev_region(&amp;<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>, 0, <a class="code" href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a>, <span class="stringliteral">&quot;as_driver&quot;</span>) &lt; 0) {</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;kernel function alloc_chrdev_region failed. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  }</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  <span class="comment">/* Create device class for the devices */</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  <span class="keywordflow">if</span> ((<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a> = class_create(THIS_MODULE, <span class="stringliteral">&quot;as_driver&quot;</span>)) == NULL) {</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;kernel function class_create failed. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    unregister_chrdev_region(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>, <a class="code" href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a>);</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  }</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160; </div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;  <span class="comment">/* Index is zero as this is the first device */</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;  <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a> = 0;</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160; </div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;  <span class="comment">/* Set defaults for control device; Init pointers to NULL */</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  <a class="code" href="group__as__driver.html#ga31acf76a64c66c9d65ea0ef597fb1713">set_device_defaults</a>(<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>);</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160; </div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#a69146f72ec71cb7494db74b14cd4b472">fops</a> = &amp;<a class="code" href="group__as__driver.html#ga64923ef94173c53c95fed2b910bdc4f2">as_control_fops</a>;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;  cdev_init(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].cdev, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[0].fops);</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;  <span class="keywordflow">if</span> (cdev_add(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].cdev, <a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>, 1) == -1) {</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;kernel function cdev_add failed. Device not created.\n&quot;</span>);</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>)));</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    class_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>);</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    unregister_chrdev_region(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>, <a class="code" href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a>);</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;  }</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;  <span class="comment">/* Initialize the mutex */</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;  <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[<a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>].<a class="code" href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">access_lock</a> = <a class="code" href="group__asterics__support.html#ga5356d69ee6d0c515fddf95b1ee37712c">as_mutex_new</a>();</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>++;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160; </div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;  <a class="code" href="group__as__driver.html#gae4c0dfec5aaaf56d45c4d0b4cdf82c30">timer_shutdown</a> = <a class="code" href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a>;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160; </div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  <span class="comment">/* Setup work queue for handling code after interrupts */</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;  INIT_WORK(&amp;<a class="code" href="group__as__driver.html#ga79966fb00f8c4921b4d8c5ccc1f75515">timer_wq</a>, (<span class="keywordtype">void</span> (*)(<span class="keyword">struct</span> work_struct *))<a class="code" href="group__as__driver.html#ga29c05adf56c85ad4a2fd61bc9dcb4626">data_transfer_update_task</a>);</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160; </div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;  <span class="comment">/* Setup basic timer for interrupt blocking support and buffer synchronization */</span></div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;  timer_setup(&amp;<a class="code" href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">interrupt_timer</a>, <a class="code" href="group__as__driver.html#gacbe125809cd40fef7c72c391bffe69aa">timer_callback</a>, 0);</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  mod_timer(&amp;<a class="code" href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">interrupt_timer</a>, jiffies + <a class="code" href="group__as__driver.html#ga2e2bf358c53c278fdff9b5bfba4efd66">TIMER_INTERVAL</a>);</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160; </div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;initalized devices %i\n&quot;</span>, <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>);</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;module initialized correctly.\n&quot;</span>);</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160; </div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;  <a class="code" href="group__as__driver.html#ga99709eae761dae64ad77a24c15a99021">asterics_device</a> = &amp;pdev-&gt;dev;</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160; </div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;  <span class="comment">// create mapping using information from device tree</span></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  irq = platform_get_irq(pdev, 0);</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  <span class="keywordflow">if</span> (irq &lt;= 0) {</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Couldn&#39;t find interrupt controller in asterics entry\n&quot;</span>);</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  }</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160; </div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  ret = devm_request_irq(&amp;pdev-&gt;dev, irq, <a class="code" href="group__as__driver.html#ga63672183e1e96c3e415d84daef8616a7">as_handle_irq</a>, IRQF_SHARED, <span class="stringliteral">&quot;asterics&quot;</span>, &amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[0]);</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  <span class="keywordflow">if</span> (ret) {</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Failed to request irq: %d\n&quot;</span>, ret);</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;Successfully requested irq: %d\n&quot;</span>, irq);</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;  }</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160; </div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;  ret = <a class="code" href="as__i2c__driver_8c.html#ac7477902e372a02d6a158d747844a34f">as_driver_i2c_probe</a>(pdev);</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;  <span class="keywordflow">if</span> (ret) {</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <a class="code" href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a>(<span class="stringliteral">&quot;Failed to probe ASTERICS I2C: %d\n&quot;</span>, ret);</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  }</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160; </div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;}</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160; </div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="comment">/***************************** Destructor *****************************/</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160; </div>
<div class="line"><a name="l01265"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga3091544216659d5fd39db7f976a8840d"> 1265</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__as__driver.html#ga3091544216659d5fd39db7f976a8840d">asterics_remove</a>(<span class="keyword">struct</span> platform_device *pdev) {</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="comment">/* Remove other devices */</span></div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  <span class="keywordtype">int</span> device_index;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;  <a class="code" href="group__asterics__support.html#gae835612a0b6b8ecc68e1487ffaff8fec">as_hardware_address_t</a> addr;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160; </div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  <span class="comment">/* Signal timer to stop running */</span></div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <a class="code" href="group__as__driver.html#gae4c0dfec5aaaf56d45c4d0b4cdf82c30">timer_shutdown</a> = <a class="code" href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a>;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160; </div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;  <span class="comment">/* Delete timer */</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;  del_timer_sync(&amp;<a class="code" href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">interrupt_timer</a>);</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160; </div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;  <span class="comment">/* Delete all devices except the control device */</span></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  <span class="keywordflow">for</span> (device_index = 1; device_index &lt; <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a>; device_index++) {</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    cdev_del(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].cdev);</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    addr = (<a class="code" href="group__asterics__support.html#gae835612a0b6b8ecc68e1487ffaff8fec">as_hardware_address_t</a>)(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].baseaddress_virt - <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].offset);</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].req_mem_region_name != NULL) {</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;      iounmap(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].baseaddress_virt);</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;      release_mem_region(addr, <a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].address_range_size);</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    }</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].mmap != NULL) {</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;      <a class="code" href="group__as__buffer.html#ga24266b1c24e9679a68088a917f78ecf8">as_buffer_obj_destroy</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].mmap-&gt;buffer);</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      <a class="code" href="group__asterics__support.html#ga3a2ba9ffa2388da78d024646e73441ff">as_free</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].mmap);</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    }</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    <a class="code" href="group__asterics__support.html#ga57df9331011244df186e877459857341">as_mutex_del</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[device_index].access_lock);</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>) + device_index));</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  }</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160; </div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;  <span class="comment">/* Remove control device */</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;  <a class="code" href="group__asterics__support.html#ga57df9331011244df186e877459857341">as_mutex_del</a>(<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[0].access_lock);</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  cdev_del(&amp;<a class="code" href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a>[0].cdev);</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;  device_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>, MKDEV(MAJOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>), MINOR(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>)));</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;  class_destroy(<a class="code" href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a>);</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;  unregister_chrdev_region(<a class="code" href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a>, <a class="code" href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a>);</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;  <a class="code" href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a> = 0;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;  <a class="code" href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a>(<span class="stringliteral">&quot;driver unregistered\n&quot;</span>);</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160; </div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;  <a class="code" href="as__i2c__driver_8c.html#a695f397ab30fc0a921aba4196141c1e9">as_driver_i2c_remove</a>(pdev);</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160; </div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;}</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160; </div>
<div class="line"><a name="l01306"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga3c5eb396a9898b56c9dd541c07a1d1a0"> 1306</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>of_device_id <a class="code" href="group__as__driver.html#ga3c5eb396a9898b56c9dd541c07a1d1a0">asterics_of_match_table</a>[] = {</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    {.compatible = <span class="stringliteral">&quot;asterics&quot;</span>, (<span class="keywordtype">void</span> *)NULL <span class="comment">/* data */</span>},</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    {},</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;};</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<a class="code" href="group__as__driver.html#ga5c62b5c955d9e88e14652836e82fe44e">MODULE_DEVICE_TABLE</a>(of, <a class="code" href="group__as__driver.html#ga3c5eb396a9898b56c9dd541c07a1d1a0">asterics_of_match_table</a>);</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160; </div>
<div class="line"><a name="l01312"></a><span class="lineno"><a class="line" href="group__as__driver.html#ga343e36ec90ab3f9f8dfc4020fbbd0060"> 1312</a></span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span>platform_driver <a class="code" href="group__as__driver.html#ga343e36ec90ab3f9f8dfc4020fbbd0060">asterics_driver</a> = {</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    .probe = <a class="code" href="group__as__driver.html#ga6d23d0b288768770efba635a43d7f541">asterics_probe</a>,</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    .remove = <a class="code" href="group__as__driver.html#ga3091544216659d5fd39db7f976a8840d">asterics_remove</a>,</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    .driver =</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        {</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;            .name = <span class="stringliteral">&quot;asterics&quot;</span>,</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;            .of_match_table = <a class="code" href="group__as__driver.html#ga3c5eb396a9898b56c9dd541c07a1d1a0">asterics_of_match_table</a>,</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        },</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;};</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<a class="code" href="group__as__driver.html#ga5dc4e18b40a67ccf4424b1a648fe9d8b">module_platform_driver</a>(<a class="code" href="group__as__driver.html#ga343e36ec90ab3f9f8dfc4020fbbd0060">asterics_driver</a>);</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160; </div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="comment">/* Module information */</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160; </div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;<a class="code" href="as__driver_8c.html#a835c763ed9cce2be12762713aeb3ccf2">MODULE_AUTHOR</a>(<span class="stringliteral">&quot;Alexander Zoellner&quot;</span>);</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;<a class="code" href="as__driver_8c.html#a835c763ed9cce2be12762713aeb3ccf2">MODULE_AUTHOR</a>(<span class="stringliteral">&quot;Patrick Zacharias&quot;</span>);</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;<a class="code" href="as__driver_8c.html#ad94b36675e7eb067ea3ce6ff9e244a44">MODULE_LICENSE</a>(<span class="stringliteral">&quot;GPL&quot;</span>);</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<a class="code" href="as__driver_8c.html#a3b0fd20f155add04de5b159475244423">MODULE_DESCRIPTION</a>(<span class="stringliteral">&quot;ASTERICS driver&quot;</span>);</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;<a class="code" href="as__driver_8c.html#a5ea17d21f3b79af6384eecc02eda3069">MODULE_SUPPORTED_DEVICE</a>(<span class="stringliteral">&quot;none&quot;</span>);</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="agroup__asterics__support_html_gae3b7e8096f52ae7a01a2857ea5883dc2"><div class="ttname"><a href="group__asterics__support.html#gae3b7e8096f52ae7a01a2857ea5883dc2">AS_BOOL</a></div><div class="ttdeci">#define AS_BOOL</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00109">as_support.h:109</a></div></div>
<div class="ttc" id="aas__memio_8h_html"><div class="ttname"><a href="as__memio_8h.html">as_memio.h</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a4b19332dd52cdd54cd68c3c7e9ccec06"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a4b19332dd52cdd54cd68c3c7e9ccec06">AS_IOCTL_CMD_READ</a></div><div class="ttdeci">#define AS_IOCTL_CMD_READ</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00103">as_linux_kernel_if.h:103</a></div></div>
<div class="ttc" id="aunionbuffer__info__t_html_a292ff81808489b043da596bb6e4068ad"><div class="ttname"><a href="unionbuffer__info__t.html#a292ff81808489b043da596bb6e4068ad">buffer_info_t::config</a></div><div class="ttdeci">as_buffer_config_t config</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00057">as_linux_kernel_if.h:57</a></div></div>
<div class="ttc" id="agroup__ctrl__file__ops_html_gae869fa3bd595179fcf2a22ff931aee9c"><div class="ttname"><a href="group__ctrl__file__ops.html#gae869fa3bd595179fcf2a22ff931aee9c">as_control_ioctl</a></div><div class="ttdeci">static long as_control_ioctl(struct file *f, unsigned int ioctl_num, unsigned long ioctl_param)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00137">as_driver.c:137</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_gab3f2465225201507d51787478ac5955a"><div class="ttname"><a href="group__as__reader__writer.html#gab3f2465225201507d51787478ac5955a">as_reader_writer_is_pending_go</a></div><div class="ttdeci">AS_BOOL as_reader_writer_is_pending_go(as_hardware_address_t base_addr)</div><div class="ttdoc">Checks if another operation is queued.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00105">as_reader_writer.c:105</a></div></div>
<div class="ttc" id="astructas__ctrl__params__t_html_adf51881e8a664e0749ec03346de3cc4b"><div class="ttname"><a href="structas__ctrl__params__t.html#adf51881e8a664e0749ec03346de3cc4b">as_ctrl_params_t::buffer</a></div><div class="ttdeci">buffer_info_t buffer</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00072">as_linux_kernel_if.h:72</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a754768ccb8ac91c85bd514842ef6a15c"><div class="ttname"><a href="structdevice__data__t.html#a754768ccb8ac91c85bd514842ef6a15c">device_data_t::register_intr</a></div><div class="ttdeci">AS_BOOL register_intr</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00101">as_driver.h:101</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a696efea6ea63d2a5379323ad7156e803"><div class="ttname"><a href="structdevice__info__t.html#a696efea6ea63d2a5379323ad7156e803">device_info_t::manage_cache</a></div><div class="ttdeci">char manage_cache</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00051">as_linux_kernel_if.h:51</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga3091544216659d5fd39db7f976a8840d"><div class="ttname"><a href="group__as__driver.html#ga3091544216659d5fd39db7f976a8840d">asterics_remove</a></div><div class="ttdeci">static int asterics_remove(struct platform_device *pdev)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01265">as_driver.c:1265</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a32f86fc61d4ff270a55a7429c1c25d96ada6ff6022a9eebd4e8356b001435b5e4"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96ada6ff6022a9eebd4e8356b001435b5e4">DEV_TYPE_I2C</a></div><div class="ttdeci">@ DEV_TYPE_I2C</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00088">as_linux_kernel_if.h:88</a></div></div>
<div class="ttc" id="astructas__ctrl__params__t_html_a0ad47ba0c626bdb9e33c3c71c8be3260"><div class="ttname"><a href="structas__ctrl__params__t.html#a0ad47ba0c626bdb9e33c3c71c8be3260">as_ctrl_params_t::cmd</a></div><div class="ttdeci">int cmd</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00069">as_linux_kernel_if.h:69</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a00080b87bc47ff7434b2951168b870cb"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a00080b87bc47ff7434b2951168b870cb">CMD_CREATE_BUFFER</a></div><div class="ttdeci">#define CMD_CREATE_BUFFER</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00082">as_linux_kernel_if.h:82</a></div></div>
<div class="ttc" id="aas__driver_8h_html"><div class="ttname"><a href="as__driver_8h.html">as_driver.h</a></div><div class="ttdoc">Linux kernel driver header file.</div></div>
<div class="ttc" id="aas__memio_8h_html_ad320e21e013ae05d9b66c50acb5bbc65"><div class="ttname"><a href="as__memio_8h.html#ad320e21e013ae05d9b66c50acb5bbc65">AS_MEMIO_DEFAULT_MAX_BURST_LENGTH</a></div><div class="ttdeci">#define AS_MEMIO_DEFAULT_MAX_BURST_LENGTH</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00044">as_memio.h:44</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga63672183e1e96c3e415d84daef8616a7"><div class="ttname"><a href="group__as__driver.html#ga63672183e1e96c3e415d84daef8616a7">as_handle_irq</a></div><div class="ttdeci">static irqreturn_t as_handle_irq(int irq, void *arg)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00124">as_driver.c:124</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga813ce7f0e5f525b7e7940ee3d9f50771"><div class="ttname"><a href="group__asterics__support.html#ga813ce7f0e5f525b7e7940ee3d9f50771">AS_FALSE</a></div><div class="ttdeci">#define AS_FALSE</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00111">as_support.h:111</a></div></div>
<div class="ttc" id="astructas__buffer__obj__s_html_a2ca0e4366afe8a4fa2594ad2d2a5681d"><div class="ttname"><a href="structas__buffer__obj__s.html#a2ca0e4366afe8a4fa2594ad2d2a5681d">as_buffer_obj_s::transfer_size</a></div><div class="ttdeci">uint32_t transfer_size</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00077">as_buffer.h:77</a></div></div>
<div class="ttc" id="astructas__memio__config__s_html_ad4768b062910f920a79092f81c42d482"><div class="ttname"><a href="structas__memio__config__s.html#ad4768b062910f920a79092f81c42d482">as_memio_config_s::as_reader_writer_transfer_size</a></div><div class="ttdeci">uint32_t as_reader_writer_transfer_size</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00080">as_memio.h:80</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga5c62b5c955d9e88e14652836e82fe44e"><div class="ttname"><a href="group__as__driver.html#ga5c62b5c955d9e88e14652836e82fe44e">MODULE_DEVICE_TABLE</a></div><div class="ttdeci">MODULE_DEVICE_TABLE(of, asterics_of_match_table)</div></div>
<div class="ttc" id="agroup__as__driver_html_ga9b1586b4163d507bd1e712e112fd530b"><div class="ttname"><a href="group__as__driver.html#ga9b1586b4163d507bd1e712e112fd530b">interrupt_timer</a></div><div class="ttdeci">static struct timer_list interrupt_timer</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00064">as_driver.c:64</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga9baf21cac3b4034ca9c89bce7d82185b"><div class="ttname"><a href="group__as__driver.html#ga9baf21cac3b4034ca9c89bce7d82185b">cl</a></div><div class="ttdeci">static struct class * cl</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00068">as_driver.c:68</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_ga4be2b60d2ac888f473e52f39c9492368"><div class="ttname"><a href="group__as__buffer.html#ga4be2b60d2ac888f473e52f39c9492368">as_buffer_update_state</a></div><div class="ttdeci">void as_buffer_update_state(as_buffer_obj_t *buf, as_hardware_address_t module_address, AS_BOOL supports_data_unit, AS_BOOL manage_cache)</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8c_source.html#l00199">as_buffer.c:199</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a32f86fc61d4ff270a55a7429c1c25d96a5aabcbd88523677d66192b6a07205c7c"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96a5aabcbd88523677d66192b6a07205c7c">DEV_TYPE_REGIO</a></div><div class="ttdeci">@ DEV_TYPE_REGIO</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00088">as_linux_kernel_if.h:88</a></div></div>
<div class="ttc" id="agroup__mmap__file__ops_html_gae18f99f9774b7224e71d80209ecd0bf4"><div class="ttname"><a href="group__mmap__file__ops.html#gae18f99f9774b7224e71d80209ecd0bf4">driver_as_mmap_read</a></div><div class="ttdeci">static ssize_t driver_as_mmap_read(struct file *filp, char __user *buffer, size_t count, loff_t *offp)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00749">as_driver.c:749</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga76fddcf4f49879e23eb70265c2b7f043"><div class="ttname"><a href="group__as__driver.html#ga76fddcf4f49879e23eb70265c2b7f043">as_memio_fops</a></div><div class="ttdeci">static struct file_operations as_memio_fops</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00076">as_driver.c:76</a></div></div>
<div class="ttc" id="agroup__memio__file__ops_html_gabc26947002eedee4c4557faff325074e"><div class="ttname"><a href="group__memio__file__ops.html#gabc26947002eedee4c4557faff325074e">driver_as_memio_read</a></div><div class="ttdeci">static ssize_t driver_as_memio_read(struct file *filp, char __user *buffer, size_t count, loff_t *offp)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00487">as_driver.c:487</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a871978a813f8a7e7b9f32127faaf2087"><div class="ttname"><a href="structdevice__data__t.html#a871978a813f8a7e7b9f32127faaf2087">device_data_t::req_mem_region_name</a></div><div class="ttdeci">char * req_mem_region_name</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00112">as_driver.h:112</a></div></div>
<div class="ttc" id="agroup__as__driver_html_gae3348ed9932819db57c693c17e5658ee"><div class="ttname"><a href="group__as__driver.html#gae3348ed9932819db57c693c17e5658ee">first</a></div><div class="ttdeci">static dev_t first</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00066">as_driver.c:66</a></div></div>
<div class="ttc" id="agroup__i2c__file__ops_html_gac4209ea12d9dea0d155e513bbaff4bc2"><div class="ttname"><a href="group__i2c__file__ops.html#gac4209ea12d9dea0d155e513bbaff4bc2">as_i2c_ioctl</a></div><div class="ttdeci">static long as_i2c_ioctl(struct file *f, uint32_t ioctl_num, unsigned long ioctl_param)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00629">as_driver.c:629</a></div></div>
<div class="ttc" id="astructmmap__info_html_aae91c16cbc39d3e7f8a3687f9962590a"><div class="ttname"><a href="structmmap__info.html#aae91c16cbc39d3e7f8a3687f9962590a">mmap_info::size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00066">as_driver.h:66</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a2f1bec5102f6d86750600b06a08601a6"><div class="ttname"><a href="structdevice__info__t.html#a2f1bec5102f6d86750600b06a08601a6">device_info_t::address</a></div><div class="ttdeci">as_hardware_address_t address</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00047">as_linux_kernel_if.h:47</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga0514d205dfb3e4f09e272b7a45d74889"><div class="ttname"><a href="group__asterics__support.html#ga0514d205dfb3e4f09e272b7a45d74889">as_kernel_address_t</a></div><div class="ttdeci">void * as_kernel_address_t</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00090">as_support.h:90</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_ga5eacf8741d14c77878f0aed49317c11c"><div class="ttname"><a href="group__as__buffer.html#ga5eacf8741d14c77878f0aed49317c11c">as_buffer_obj_handle_t</a></div><div class="ttdeci">uint32_t as_buffer_obj_handle_t</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00014">as_buffer.h:14</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_ab500ace747750a8e2beba0600a1b5e31"><div class="ttname"><a href="as__linux__kernel__if_8h.html#ab500ace747750a8e2beba0600a1b5e31">AS_IOCTL_CMD_MMAP_WAIT</a></div><div class="ttdeci">#define AS_IOCTL_CMD_MMAP_WAIT</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00107">as_linux_kernel_if.h:107</a></div></div>
<div class="ttc" id="astructas__buffer__obj__s_html_a1aefe55cd4725a83df55059a78290281"><div class="ttname"><a href="structas__buffer__obj__s.html#a1aefe55cd4725a83df55059a78290281">as_buffer_obj_s::buffer_size</a></div><div class="ttdeci">uint32_t buffer_size</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00075">as_buffer.h:75</a></div></div>
<div class="ttc" id="aas__driver_8c_html_a5ea17d21f3b79af6384eecc02eda3069"><div class="ttname"><a href="as__driver_8c.html#a5ea17d21f3b79af6384eecc02eda3069">MODULE_SUPPORTED_DEVICE</a></div><div class="ttdeci">MODULE_SUPPORTED_DEVICE(&quot;none&quot;)</div></div>
<div class="ttc" id="astructas__buffer__obj__s_html_ad0e4edec7a268613f6453a7ff081dfcc"><div class="ttname"><a href="structas__buffer__obj__s.html#ad0e4edec7a268613f6453a7ff081dfcc">as_buffer_obj_s::state</a></div><div class="ttdeci">as_buffer_state_t state</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00085">as_buffer.h:85</a></div></div>
<div class="ttc" id="astructas__ctrl__params__t_html_a1ac24fe05bf1d84de0c95e0061f8bae5"><div class="ttname"><a href="structas__ctrl__params__t.html#a1ac24fe05bf1d84de0c95e0061f8bae5">as_ctrl_params_t::device</a></div><div class="ttdeci">device_info_t device</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00071">as_linux_kernel_if.h:71</a></div></div>
<div class="ttc" id="astructas__ioctl__params__t_html_a43dfb50290e46dc47bb21f06231f19c2"><div class="ttname"><a href="structas__ioctl__params__t.html#a43dfb50290e46dc47bb21f06231f19c2">as_ioctl_params_t::value</a></div><div class="ttdeci">uint32_t value</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00098">as_linux_kernel_if.h:98</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga9b562fe5abd06406020981c2f19bcc0c"><div class="ttname"><a href="group__asterics__support.html#ga9b562fe5abd06406020981c2f19bcc0c">as_malloc</a></div><div class="ttdeci">static void * as_malloc(uint32_t size)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00626">as_support.h:626</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga5356d69ee6d0c515fddf95b1ee37712c"><div class="ttname"><a href="group__asterics__support.html#ga5356d69ee6d0c515fddf95b1ee37712c">as_mutex_new</a></div><div class="ttdeci">static struct as_mutex_s * as_mutex_new(void)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00529">as_support.h:529</a></div></div>
<div class="ttc" id="aas__i2c__driver_8h_html"><div class="ttname"><a href="as__i2c__driver_8h.html">as_i2c_driver.h</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_af3754737f794dcef3f3741e4f7244f40"><div class="ttname"><a href="structdevice__data__t.html#af3754737f794dcef3f3741e4f7244f40">device_data_t::busy</a></div><div class="ttdeci">atomic_t busy</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00080">as_driver.h:80</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_gaff32e081746fcba213df9a397fe33a20"><div class="ttname"><a href="group__asterics__support.html#gaff32e081746fcba213df9a397fe33a20">AS_INFO</a></div><div class="ttdeci">#define AS_INFO(...)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00238">as_support.h:238</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a86dadb29c023fbc40e6fde62dfc238dd"><div class="ttname"><a href="structdevice__info__t.html#a86dadb29c023fbc40e6fde62dfc238dd">device_info_t::address_range_size</a></div><div class="ttdeci">uint32_t address_range_size</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00048">as_linux_kernel_if.h:48</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_gae835612a0b6b8ecc68e1487ffaff8fec"><div class="ttname"><a href="group__asterics__support.html#gae835612a0b6b8ecc68e1487ffaff8fec">as_hardware_address_t</a></div><div class="ttdeci">size_t as_hardware_address_t</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00089">as_support.h:89</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga1ef22dbd33d87de51113837dd9123c6f"><div class="ttname"><a href="group__as__reader__writer.html#ga1ef22dbd33d87de51113837dd9123c6f">as_writer_set_enable</a></div><div class="ttdeci">void as_writer_set_enable(as_hardware_address_t base_addr)</div><div class="ttdoc">Enable module input port.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00133">as_reader_writer.c:133</a></div></div>
<div class="ttc" id="astructas__buffer__config__s_html_aef125ce0b78aa131ba79cd49fc55a886"><div class="ttname"><a href="structas__buffer__config__s.html#aef125ce0b78aa131ba79cd49fc55a886">as_buffer_config_s::size</a></div><div class="ttdeci">size_t size</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00037">as_buffer.h:37</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga6d23d0b288768770efba635a43d7f541"><div class="ttname"><a href="group__as__driver.html#ga6d23d0b288768770efba635a43d7f541">asterics_probe</a></div><div class="ttdeci">static int asterics_probe(struct platform_device *pdev)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01189">as_driver.c:1189</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga5dc4e18b40a67ccf4424b1a648fe9d8b"><div class="ttname"><a href="group__as__driver.html#ga5dc4e18b40a67ccf4424b1a648fe9d8b">module_platform_driver</a></div><div class="ttdeci">module_platform_driver(asterics_driver)</div></div>
<div class="ttc" id="astructdevice__data__t_html_ae421cbc510f2ef8d562015d59e598f57"><div class="ttname"><a href="structdevice__data__t.html#ae421cbc510f2ef8d562015d59e598f57">device_data_t::cdev</a></div><div class="ttdeci">struct cdev cdev</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00076">as_driver.h:76</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga343e36ec90ab3f9f8dfc4020fbbd0060"><div class="ttname"><a href="group__as__driver.html#ga343e36ec90ab3f9f8dfc4020fbbd0060">asterics_driver</a></div><div class="ttdeci">static struct platform_driver asterics_driver</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01312">as_driver.c:1312</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gga618740c22dd077a5e0744a61e9d448a8a1eb4bba19a14ef4aaad528a39cdafa8b"><div class="ttname"><a href="group__as__buffer.html#gga618740c22dd077a5e0744a61e9d448a8a1eb4bba19a14ef4aaad528a39cdafa8b">AS_BUFFER_KERN_MEM</a></div><div class="ttdeci">@ AS_BUFFER_KERN_MEM</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00020">as_buffer.h:20</a></div></div>
<div class="ttc" id="aas__cache_8c_html_a82dda14c005c5bd0028e5f25fad2923c"><div class="ttname"><a href="as__cache_8c.html#a82dda14c005c5bd0028e5f25fad2923c">as_map_single</a></div><div class="ttdeci">as_dma_address_t as_map_single(as_kernel_address_t addr, size_t bytes, as_buffer_dir_t direction, AS_BOOL cpu_sync)</div><div class="ttdoc">Map virtual kernel address for DMA.</div><div class="ttdef"><b>Definition:</b> <a href="as__cache_8c_source.html#l00056">as_cache.c:56</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a97402e93c9b06ea123bacc0b50370da4"><div class="ttname"><a href="structdevice__info__t.html#a97402e93c9b06ea123bacc0b50370da4">device_info_t::interface_width</a></div><div class="ttdeci">uint32_t interface_width</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00049">as_linux_kernel_if.h:49</a></div></div>
<div class="ttc" id="aas__driver_8c_html_a835c763ed9cce2be12762713aeb3ccf2"><div class="ttname"><a href="as__driver_8c.html#a835c763ed9cce2be12762713aeb3ccf2">MODULE_AUTHOR</a></div><div class="ttdeci">MODULE_AUTHOR(&quot;Alexander Zoellner&quot;)</div></div>
<div class="ttc" id="aas__memio_8h_html_acce868608c8346f4cdb9a47b193cf303"><div class="ttname"><a href="as__memio_8h.html#acce868608c8346f4cdb9a47b193cf303">AS_MEMIO_DEFAULT_FIFO_BUFFER_SIZE</a></div><div class="ttdeci">#define AS_MEMIO_DEFAULT_FIFO_BUFFER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00048">as_memio.h:48</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gaae07f36c8697636591c86ec375de82c8"><div class="ttname"><a href="group__as__buffer.html#gaae07f36c8697636591c86ec375de82c8">as_buffer_obj_ptr_to_handle</a></div><div class="ttdeci">as_buffer_obj_handle_t as_buffer_obj_ptr_to_handle(as_buffer_obj_t *object)</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8c_source.html#l00073">as_buffer.c:73</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_aa3b6e2f44d2e8cda3ca75c5d6c871b23"><div class="ttname"><a href="structdevice__info__t.html#aa3b6e2f44d2e8cda3ca75c5d6c871b23">device_info_t::support_data_unit</a></div><div class="ttdeci">char support_data_unit</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00052">as_linux_kernel_if.h:52</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a118349ea2cb36ff748d3712ef24cdeed"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a118349ea2cb36ff748d3712ef24cdeed">CALLED_FROM_KERNEL</a></div><div class="ttdeci">#define CALLED_FROM_KERNEL</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00040">as_linux_kernel_if.h:40</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_gad294e0c5530bd6fb800a2394179070e1"><div class="ttname"><a href="group__asterics__support.html#gad294e0c5530bd6fb800a2394179070e1">as_mutex_lock</a></div><div class="ttdeci">static void as_mutex_lock(struct as_mutex_s *mutex)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00531">as_support.h:531</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a32f86fc61d4ff270a55a7429c1c25d96ad81ff9d53cc04f7e021deb1d266f6247"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96ad81ff9d53cc04f7e021deb1d266f6247">DEV_TYPE_MMAP</a></div><div class="ttdeci">@ DEV_TYPE_MMAP</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00088">as_linux_kernel_if.h:88</a></div></div>
<div class="ttc" id="astructas__ioctl__params__t_html_a3ce8f6c9ef2d1e8307e6623756b41d03"><div class="ttname"><a href="structas__ioctl__params__t.html#a3ce8f6c9ef2d1e8307e6623756b41d03">as_ioctl_params_t::address</a></div><div class="ttdeci">as_hardware_address_t address</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00097">as_linux_kernel_if.h:97</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga43d2f73d7d42dd5704160d4ddacfaa1e"><div class="ttname"><a href="group__as__reader__writer.html#ga43d2f73d7d42dd5704160d4ddacfaa1e">as_reader_writer_set_section_addr</a></div><div class="ttdeci">void as_reader_writer_set_section_addr(as_hardware_address_t base_addr, as_hardware_address_t value)</div><div class="ttdoc">Sets the start address of the first section to the given value.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00076">as_reader_writer.c:76</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_ad3fa6148fdb2d34dc3f25020e8d1da08"><div class="ttname"><a href="structdevice__data__t.html#ad3fa6148fdb2d34dc3f25020e8d1da08">device_data_t::manage_cache</a></div><div class="ttdeci">AS_BOOL manage_cache</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00135">as_driver.h:135</a></div></div>
<div class="ttc" id="agroup__as__driver_html_gaf539da46951af9e73b1ab080e379655e"><div class="ttname"><a href="group__as__driver.html#gaf539da46951af9e73b1ab080e379655e">as_regio_fops</a></div><div class="ttdeci">static struct file_operations as_regio_fops</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00072">as_driver.c:72</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_aedafc32ab216501fcfc474907f1285c6"><div class="ttname"><a href="structdevice__data__t.html#aedafc32ab216501fcfc474907f1285c6">device_data_t::access_lock</a></div><div class="ttdeci">struct as_mutex_s * access_lock</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00086">as_driver.h:86</a></div></div>
<div class="ttc" id="agroup__memio__file__ops_html_gab0cee6094e9d25645dcab0b9df045467"><div class="ttname"><a href="group__memio__file__ops.html#gab0cee6094e9d25645dcab0b9df045467">driver_as_memio_ioctl</a></div><div class="ttdeci">long driver_as_memio_ioctl(struct file *filp, unsigned int ioctl_num, unsigned long ioctl_param)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00388">as_driver.c:388</a></div></div>
<div class="ttc" id="agroup__as__driver_html_gaf7d21502066d9cb1cb8a5ab206567bef"><div class="ttname"><a href="group__as__driver.html#gaf7d21502066d9cb1cb8a5ab206567bef">as_mmap_fops</a></div><div class="ttdeci">struct file_operations as_mmap_fops</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00060">as_driver.c:60</a></div></div>
<div class="ttc" id="astructdevice__data__t_html"><div class="ttname"><a href="structdevice__data__t.html">device_data_t</a></div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00072">as_driver.h:72</a></div></div>
<div class="ttc" id="astructas__buffer__obj__s_html_a896566e6ea09c62f3d124c82170e8506"><div class="ttname"><a href="structas__buffer__obj__s.html#a896566e6ea09c62f3d124c82170e8506">as_buffer_obj_s::direction</a></div><div class="ttdeci">as_buffer_dir_t direction</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00087">as_buffer.h:87</a></div></div>
<div class="ttc" id="agroup__memio__file__ops_html_gafff67fc067850f545e90c7e487f4fbce"><div class="ttname"><a href="group__memio__file__ops.html#gafff67fc067850f545e90c7e487f4fbce">driver_as_memio_write</a></div><div class="ttdeci">static ssize_t driver_as_memio_write(struct file *filp, const char __user *buffer, size_t count, loff_t *offp)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00558">as_driver.c:558</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a6d0a7f3cdf5cc8d2522d12432e5dc8c4"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a6d0a7f3cdf5cc8d2522d12432e5dc8c4">AS_IOCTL_CMD_WRITE</a></div><div class="ttdeci">#define AS_IOCTL_CMD_WRITE</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00105">as_linux_kernel_if.h:105</a></div></div>
<div class="ttc" id="aas__driver_8c_html_a3b0fd20f155add04de5b159475244423"><div class="ttname"><a href="as__driver_8c.html#a3b0fd20f155add04de5b159475244423">MODULE_DESCRIPTION</a></div><div class="ttdeci">MODULE_DESCRIPTION(&quot;ASTERICS driver&quot;)</div></div>
<div class="ttc" id="agroup__as__driver_html_gacbe125809cd40fef7c72c391bffe69aa"><div class="ttname"><a href="group__as__driver.html#gacbe125809cd40fef7c72c391bffe69aa">timer_callback</a></div><div class="ttdeci">void timer_callback(struct timer_list *data)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01125">as_driver.c:1125</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_ae274832088a2c1f08760d1f0d07a05e3"><div class="ttname"><a href="structdevice__data__t.html#ae274832088a2c1f08760d1f0d07a05e3">device_data_t::memio_active</a></div><div class="ttdeci">AS_BOOL memio_active</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00131">as_driver.h:131</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gga2dcb272d5e81b867b7d60a2f84fce484a8b76d66328ed9fbf4c4992153ccc8e4e"><div class="ttname"><a href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a8b76d66328ed9fbf4c4992153ccc8e4e">AS_BUFFER_STATE_OWN_CPU</a></div><div class="ttdeci">@ AS_BUFFER_STATE_OWN_CPU</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00063">as_buffer.h:63</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga99709eae761dae64ad77a24c15a99021"><div class="ttname"><a href="group__as__driver.html#ga99709eae761dae64ad77a24c15a99021">asterics_device</a></div><div class="ttdeci">struct device * asterics_device</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00061">as_driver.c:61</a></div></div>
<div class="ttc" id="aas__driver_8c_html_ad94b36675e7eb067ea3ce6ff9e244a44"><div class="ttname"><a href="as__driver_8c.html#ad94b36675e7eb067ea3ce6ff9e244a44">MODULE_LICENSE</a></div><div class="ttdeci">MODULE_LICENSE(&quot;GPL&quot;)</div></div>
<div class="ttc" id="astructas__ioctl__params__t_html_a516725593a41c106a236205a180dd4cf"><div class="ttname"><a href="structas__ioctl__params__t.html#a516725593a41c106a236205a180dd4cf">as_ioctl_params_t::cmd</a></div><div class="ttdeci">uint32_t cmd</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00096">as_linux_kernel_if.h:96</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gga2dcb272d5e81b867b7d60a2f84fce484a6a1a440627004c448361b8f493c345f7"><div class="ttname"><a href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a6a1a440627004c448361b8f493c345f7">AS_BUFFER_STATE_OWN_DEVICE</a></div><div class="ttdeci">@ AS_BUFFER_STATE_OWN_DEVICE</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00061">as_buffer.h:61</a></div></div>
<div class="ttc" id="agroup__as__driver_html_gae4c0dfec5aaaf56d45c4d0b4cdf82c30"><div class="ttname"><a href="group__as__driver.html#gae4c0dfec5aaaf56d45c4d0b4cdf82c30">timer_shutdown</a></div><div class="ttdeci">AS_BOOL timer_shutdown</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00058">as_driver.c:58</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga3c5eb396a9898b56c9dd541c07a1d1a0"><div class="ttname"><a href="group__as__driver.html#ga3c5eb396a9898b56c9dd541c07a1d1a0">asterics_of_match_table</a></div><div class="ttdeci">static const struct of_device_id asterics_of_match_table[]</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01306">as_driver.c:1306</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga31acf76a64c66c9d65ea0ef597fb1713"><div class="ttname"><a href="group__as__driver.html#ga31acf76a64c66c9d65ea0ef597fb1713">set_device_defaults</a></div><div class="ttdeci">void set_device_defaults(unsigned int index)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00112">as_driver.c:112</a></div></div>
<div class="ttc" id="aas__reader__writer_8h_html"><div class="ttname"><a href="as__reader__writer_8h.html">as_reader_writer.h</a></div><div class="ttdoc">Driver (header file) for as_reader_writer module.</div></div>
<div class="ttc" id="astructas__memio__config__s_html_a655f697322308adc1823754d498f06c7"><div class="ttname"><a href="structas__memio__config__s.html#a655f697322308adc1823754d498f06c7">as_memio_config_s::as_reader_writer_buffer_size</a></div><div class="ttdeci">uint32_t as_reader_writer_buffer_size</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00079">as_memio.h:79</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga82d296191367051aed6c7f38ab799656"><div class="ttname"><a href="group__as__driver.html#ga82d296191367051aed6c7f38ab799656">device_data</a></div><div class="ttdeci">static struct device_data_t device_data[MAX_DEVICES]</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00083">as_driver.c:83</a></div></div>
<div class="ttc" id="agroup__as__driver_html_gaeb950efba23d7cc1f5eca59ff463f329"><div class="ttname"><a href="group__as__driver.html#gaeb950efba23d7cc1f5eca59ff463f329">as_i2c_fops</a></div><div class="ttdeci">static struct file_operations as_i2c_fops</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00074">as_driver.c:74</a></div></div>
<div class="ttc" id="astructmmap__info_html_aac3f4661ad954c239c617d3e8a7b6b61"><div class="ttname"><a href="structmmap__info.html#aac3f4661ad954c239c617d3e8a7b6b61">mmap_info::buffer</a></div><div class="ttdeci">as_buffer_obj_t * buffer</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00064">as_driver.h:64</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_afaa0e2c3e77e2a5084bffdc6e715daf5"><div class="ttname"><a href="structdevice__data__t.html#afaa0e2c3e77e2a5084bffdc6e715daf5">device_data_t::support_data_unit</a></div><div class="ttdeci">AS_BOOL support_data_unit</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00137">as_driver.h:137</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_ga90f980b27c24955418f94f617402c7e7"><div class="ttname"><a href="group__as__buffer.html#ga90f980b27c24955418f94f617402c7e7">as_buffer_obj_create</a></div><div class="ttdeci">as_buffer_obj_t * as_buffer_obj_create(as_buffer_config_t *config)</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8c_source.html#l00034">as_buffer.c:34</a></div></div>
<div class="ttc" id="agroup__regio__file__ops_html_gaf8e5004303614b224621b34e965c510a"><div class="ttname"><a href="group__regio__file__ops.html#gaf8e5004303614b224621b34e965c510a">as_regio_ioctl</a></div><div class="ttdeci">long as_regio_ioctl(struct file *filp, unsigned int ioctl_num, unsigned long ioctl_param)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00326">as_driver.c:326</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_aa9dd21edb525f6096969c1dc4f7424e8"><div class="ttname"><a href="structdevice__data__t.html#aa9dd21edb525f6096969c1dc4f7424e8">device_data_t::wait</a></div><div class="ttdeci">wait_queue_head_t wait</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00103">as_driver.h:103</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_afb85a1fffb7a72d85f59475a3e9bc384"><div class="ttname"><a href="structdevice__data__t.html#afb85a1fffb7a72d85f59475a3e9bc384">device_data_t::hw_module_addr</a></div><div class="ttdeci">as_hardware_address_t hw_module_addr</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00093">as_driver.h:93</a></div></div>
<div class="ttc" id="aas__i2c__driver_8c_html_a695f397ab30fc0a921aba4196141c1e9"><div class="ttname"><a href="as__i2c__driver_8c.html#a695f397ab30fc0a921aba4196141c1e9">as_driver_i2c_remove</a></div><div class="ttdeci">int as_driver_i2c_remove(struct platform_device *pdev)</div><div class="ttdef"><b>Definition:</b> <a href="as__i2c__driver_8c_source.html#l00069">as_i2c_driver.c:69</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a32f86fc61d4ff270a55a7429c1c25d96af7ff0936c190efe7bda231e679a5bdb2"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a32f86fc61d4ff270a55a7429c1c25d96af7ff0936c190efe7bda231e679a5bdb2">DEV_TYPE_MEMIO</a></div><div class="ttdeci">@ DEV_TYPE_MEMIO</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00088">as_linux_kernel_if.h:88</a></div></div>
<div class="ttc" id="astructas__ioctl__params__t_html"><div class="ttname"><a href="structas__ioctl__params__t.html">as_ioctl_params_t</a></div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00095">as_linux_kernel_if.h:95</a></div></div>
<div class="ttc" id="aas__memio_8c_html_acc05505f22ed7950a0d997708c6570b4"><div class="ttname"><a href="as__memio_8c.html#acc05505f22ed7950a0d997708c6570b4">as_memio_open</a></div><div class="ttdeci">as_memio_file_t * as_memio_open(as_hardware_address_t as_reader_writer_baseaddr, as_memio_config_t *memio_config, uint8_t flags)</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8c_source.html#l00093">as_memio.c:93</a></div></div>
<div class="ttc" id="astructas__memio__config__s_html_abc270fc287118e6ea677458de8de6337"><div class="ttname"><a href="structas__memio__config__s.html#abc270fc287118e6ea677458de8de6337">as_memio_config_s::as_reader_writer_max_burst_length</a></div><div class="ttdeci">uint32_t as_reader_writer_max_burst_length</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00081">as_memio.h:81</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga7039cf09cbd9c685b8b6f35a5828e8f2"><div class="ttname"><a href="group__as__driver.html#ga7039cf09cbd9c685b8b6f35a5828e8f2">log2_ceil</a></div><div class="ttdeci">int log2_ceil(unsigned long long size)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00093">as_driver.c:93</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga4e132cfaa78353e3af1474a86b2dd535"><div class="ttname"><a href="group__as__driver.html#ga4e132cfaa78353e3af1474a86b2dd535">MAX_DEVICES</a></div><div class="ttdeci">#define MAX_DEVICES</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00050">as_driver.h:50</a></div></div>
<div class="ttc" id="astructas__ctrl__params__t_html"><div class="ttname"><a href="structas__ctrl__params__t.html">as_ctrl_params_t</a></div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00068">as_linux_kernel_if.h:68</a></div></div>
<div class="ttc" id="agroup__memio__file__ops_html_gacbc077ab5c70f951062f1a7bbd311957"><div class="ttname"><a href="group__memio__file__ops.html#gacbc077ab5c70f951062f1a7bbd311957">driver_as_memio_close</a></div><div class="ttdeci">static int driver_as_memio_close(struct inode *device_file, struct file *filp)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00462">as_driver.c:462</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a4aeadbb57d7fd393d5c22b36701049a2"><div class="ttname"><a href="structdevice__data__t.html#a4aeadbb57d7fd393d5c22b36701049a2">device_data_t::memio_file</a></div><div class="ttdeci">struct as_memio_file_s * memio_file</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00133">as_driver.h:133</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga2c3650318b12edaf3f4473fed557cc74"><div class="ttname"><a href="group__as__reader__writer.html#ga2c3650318b12edaf3f4473fed557cc74">as_writer_set_disable_on_no_go</a></div><div class="ttdeci">void as_writer_set_disable_on_no_go(as_hardware_address_t base_addr)</div><div class="ttdoc">Disable module if no operation is queued.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00149">as_reader_writer.c:149</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a154d1eb426906bfcb3dc2fefa3144a0b"><div class="ttname"><a href="structdevice__info__t.html#a154d1eb426906bfcb3dc2fefa3144a0b">device_info_t::type</a></div><div class="ttdeci">int type</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00046">as_linux_kernel_if.h:46</a></div></div>
<div class="ttc" id="aas__buffer_8h_html"><div class="ttname"><a href="as__buffer_8h.html">as_buffer.h</a></div><div class="ttdoc">Header filer containing structure definitions for use of ASTERICS buffer objects.</div></div>
<div class="ttc" id="aas__memio_8c_html_ae26886688375b0c299ac4ce257ce92f5"><div class="ttname"><a href="as__memio_8c.html#ae26886688375b0c299ac4ce257ce92f5">as_memio_read</a></div><div class="ttdeci">ssize_t as_memio_read(as_memio_file_t *fd, void *buffer, uint32_t count)</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8c_source.html#l00335">as_memio.c:335</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a024a37217850ca62924915ae058d50c1"><div class="ttname"><a href="structdevice__data__t.html#a024a37217850ca62924915ae058d50c1">device_data_t::wake_up_cond</a></div><div class="ttdeci">uint8_t wake_up_cond</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00105">as_driver.h:105</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_gac1620201206b65f8e52f1f2c9cecd49c"><div class="ttname"><a href="group__asterics__support.html#gac1620201206b65f8e52f1f2c9cecd49c">AS_WARNING</a></div><div class="ttdeci">#define AS_WARNING(...)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00240">as_support.h:240</a></div></div>
<div class="ttc" id="astructas__buffer__obj__s_html_a65ba4516cd1d80b097b9cd9874d635cd"><div class="ttname"><a href="structas__buffer__obj__s.html#a65ba4516cd1d80b097b9cd9874d635cd">as_buffer_obj_s::buffer_baseaddr_virt</a></div><div class="ttdeci">as_kernel_address_t buffer_baseaddr_virt</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00071">as_buffer.h:71</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga2e2bf358c53c278fdff9b5bfba4efd66"><div class="ttname"><a href="group__as__driver.html#ga2e2bf358c53c278fdff9b5bfba4efd66">TIMER_INTERVAL</a></div><div class="ttdeci">#define TIMER_INTERVAL</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00058">as_driver.h:58</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a69146f72ec71cb7494db74b14cd4b472"><div class="ttname"><a href="structdevice__data__t.html#a69146f72ec71cb7494db74b14cd4b472">device_data_t::fops</a></div><div class="ttdeci">void * fops</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00083">as_driver.h:83</a></div></div>
<div class="ttc" id="astructmmap__info_html"><div class="ttname"><a href="structmmap__info.html">mmap_info</a></div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00061">as_driver.h:61</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga6d267663858ff69ae0c1da1dd11f28e7"><div class="ttname"><a href="group__asterics__support.html#ga6d267663858ff69ae0c1da1dd11f28e7">AS_ERROR</a></div><div class="ttdeci">#define AS_ERROR(...)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00242">as_support.h:242</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga3a2ba9ffa2388da78d024646e73441ff"><div class="ttname"><a href="group__asterics__support.html#ga3a2ba9ffa2388da78d024646e73441ff">as_free</a></div><div class="ttdeci">static void as_free(void *objp)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00627">as_support.h:627</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a"><div class="ttname"><a href="group__as__buffer.html#gga2dcb272d5e81b867b7d60a2f84fce484a904700c2b11dd0686558c6f2132d804a">AS_BUFFER_STATE_INACTIVE</a></div><div class="ttdeci">@ AS_BUFFER_STATE_INACTIVE</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00057">as_buffer.h:57</a></div></div>
<div class="ttc" id="astructas__memio__config__s_html_ac322dd709086f967b4801a4aaa1c438e"><div class="ttname"><a href="structas__memio__config__s.html#ac322dd709086f967b4801a4aaa1c438e">as_memio_config_s::as_reader_writer_interface_width</a></div><div class="ttdeci">uint32_t as_reader_writer_interface_width</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00082">as_memio.h:82</a></div></div>
<div class="ttc" id="agroup__memio__file__ops_html_ga6a581341bc6e2a1ed45c56c0fc7bcece"><div class="ttname"><a href="group__memio__file__ops.html#ga6a581341bc6e2a1ed45c56c0fc7bcece">driver_as_memio_open</a></div><div class="ttdeci">static int driver_as_memio_open(struct inode *device_file, struct file *filp)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00403">as_driver.c:403</a></div></div>
<div class="ttc" id="aas__memio_8c_html_a1d306d68268eb68703b595cb416c5024"><div class="ttname"><a href="as__memio_8c.html#a1d306d68268eb68703b595cb416c5024">as_memio_write</a></div><div class="ttdeci">ssize_t as_memio_write(as_memio_file_t *fd, const void *buffer, uint32_t count)</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8c_source.html#l00397">as_memio.c:397</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a35b185c1012d4209fa0674a77227ba61"><div class="ttname"><a href="structdevice__data__t.html#a35b185c1012d4209fa0674a77227ba61">device_data_t::interface_width</a></div><div class="ttdeci">uint32_t interface_width</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00095">as_driver.h:95</a></div></div>
<div class="ttc" id="astructas__buffer__obj__s_html_ae95907c4fbcdd18eb4ad059419247061"><div class="ttname"><a href="structas__buffer__obj__s.html#ae95907c4fbcdd18eb4ad059419247061">as_buffer_obj_s::buffer_baseaddr_phys</a></div><div class="ttdeci">as_hardware_address_t buffer_baseaddr_phys</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00069">as_buffer.h:69</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_adc4105db9303ffcacb093b72c8bbe981"><div class="ttname"><a href="structdevice__data__t.html#adc4105db9303ffcacb093b72c8bbe981">device_data_t::offset</a></div><div class="ttdeci">ptrdiff_t offset</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00116">as_driver.h:116</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga8ffa108d758f416593d508d00fdbfed6"><div class="ttname"><a href="group__as__reader__writer.html#ga8ffa108d758f416593d508d00fdbfed6">as_writer_is_sync_error</a></div><div class="ttdeci">AS_BOOL as_writer_is_sync_error(as_hardware_address_t base_addr)</div><div class="ttdoc">Checks if module has dropped data.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00110">as_reader_writer.c:110</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_gae4efbb43f7b98bd321a8f2fb14599b54"><div class="ttname"><a href="group__asterics__support.html#gae4efbb43f7b98bd321a8f2fb14599b54">AS_TRUE</a></div><div class="ttdeci">#define AS_TRUE</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00110">as_support.h:110</a></div></div>
<div class="ttc" id="agroup__mmap__file__ops_html_ga2818d1d7a0430100ab879f5a385e849b"><div class="ttname"><a href="group__mmap__file__ops.html#ga2818d1d7a0430100ab879f5a385e849b">driver_as_mmap</a></div><div class="ttdeci">static int driver_as_mmap(struct file *filp, struct vm_area_struct *vma)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00710">as_driver.c:710</a></div></div>
<div class="ttc" id="agroup__as__driver_html_gac18f7fe4a9da5beb7bb9e3e95165e979"><div class="ttname"><a href="group__as__driver.html#gac18f7fe4a9da5beb7bb9e3e95165e979">initialized_devices</a></div><div class="ttdeci">static unsigned int initialized_devices</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00070">as_driver.c:70</a></div></div>
<div class="ttc" id="agroup__mmap__file__ops_html_gab078c489a563497f4da70a9f6115dfce"><div class="ttname"><a href="group__mmap__file__ops.html#gab078c489a563497f4da70a9f6115dfce">as_mmap_ioctl</a></div><div class="ttdeci">static long as_mmap_ioctl(struct file *filp, uint32_t ioctl_num, unsigned long ioctl_param)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00993">as_driver.c:993</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gga79d77438f1c5c83a66b218ade7beb5c6a46f9696f7461572425be23a9bc709a4c"><div class="ttname"><a href="group__as__buffer.html#gga79d77438f1c5c83a66b218ade7beb5c6a46f9696f7461572425be23a9bc709a4c">AS_BUFFER_DIR_TO_DEV</a></div><div class="ttdeci">@ AS_BUFFER_DIR_TO_DEV</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00027">as_buffer.h:27</a></div></div>
<div class="ttc" id="astructas__memio__config__s_html"><div class="ttname"><a href="structas__memio__config__s.html">as_memio_config_s</a></div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00078">as_memio.h:78</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a3237bc897f05416ea63d14ae73030475"><div class="ttname"><a href="structdevice__info__t.html#a3237bc897f05416ea63d14ae73030475">device_info_t::name</a></div><div class="ttdeci">char name[20]</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00045">as_linux_kernel_if.h:45</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_gga79d77438f1c5c83a66b218ade7beb5c6a88efb34059cd3c07368aa92a75ca2860"><div class="ttname"><a href="group__as__buffer.html#gga79d77438f1c5c83a66b218ade7beb5c6a88efb34059cd3c07368aa92a75ca2860">AS_BUFFER_DIR_FROM_DEV</a></div><div class="ttdeci">@ AS_BUFFER_DIR_FROM_DEV</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00029">as_buffer.h:29</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga29c05adf56c85ad4a2fd61bc9dcb4626"><div class="ttname"><a href="group__as__driver.html#ga29c05adf56c85ad4a2fd61bc9dcb4626">data_transfer_update_task</a></div><div class="ttdeci">void data_transfer_update_task(unsigned long arg)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01103">as_driver.c:1103</a></div></div>
<div class="ttc" id="astructas__memio__config__s_html_a931fdf22611679f0bc44c39979a9ca15"><div class="ttname"><a href="structas__memio__config__s.html#a931fdf22611679f0bc44c39979a9ca15">as_memio_config_s::manage_cache</a></div><div class="ttdeci">AS_BOOL manage_cache</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00083">as_memio.h:83</a></div></div>
<div class="ttc" id="aas__i2c__driver_8c_html_ac7477902e372a02d6a158d747844a34f"><div class="ttname"><a href="as__i2c__driver_8c.html#ac7477902e372a02d6a158d747844a34f">as_driver_i2c_probe</a></div><div class="ttdeci">int as_driver_i2c_probe(struct platform_device *pdev)</div><div class="ttdef"><b>Definition:</b> <a href="as__i2c__driver_8c_source.html#l00040">as_i2c_driver.c:40</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a2668b791ab3218be20407fc694037087"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a2668b791ab3218be20407fc694037087">CMD_REMOVE_DEVICE</a></div><div class="ttdeci">#define CMD_REMOVE_DEVICE</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00080">as_linux_kernel_if.h:80</a></div></div>
<div class="ttc" id="aas__memio_8h_html_a709cbef4f931989bffb66ea3de9b4a9f"><div class="ttname"><a href="as__memio_8h.html#a709cbef4f931989bffb66ea3de9b4a9f">AS_MEMIO_DEFAULT_HW_TRANSFER_SIZE</a></div><div class="ttdeci">#define AS_MEMIO_DEFAULT_HW_TRANSFER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8h_source.html#l00046">as_memio.h:46</a></div></div>
<div class="ttc" id="aas__memio_8c_html_a2d1779f68606dd78a78a331a6c261a43"><div class="ttname"><a href="as__memio_8c.html#a2d1779f68606dd78a78a331a6c261a43">as_memio_hw_update</a></div><div class="ttdeci">void as_memio_hw_update(as_memio_file_t *fd)</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8c_source.html#l00286">as_memio.c:286</a></div></div>
<div class="ttc" id="agroup__as__buffer_html_ga24266b1c24e9679a68088a917f78ecf8"><div class="ttname"><a href="group__as__buffer.html#ga24266b1c24e9679a68088a917f78ecf8">as_buffer_obj_destroy</a></div><div class="ttdeci">void as_buffer_obj_destroy(as_buffer_obj_t *object)</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8c_source.html#l00060">as_buffer.c:60</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga64923ef94173c53c95fed2b910bdc4f2"><div class="ttname"><a href="group__as__driver.html#ga64923ef94173c53c95fed2b910bdc4f2">as_control_fops</a></div><div class="ttdeci">static struct file_operations as_control_fops</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l01154">as_driver.c:1154</a></div></div>
<div class="ttc" id="astructas__ioctl__params__t_html_aedaff71920db4dc2701fe9be734c4c6d"><div class="ttname"><a href="structas__ioctl__params__t.html#aedaff71920db4dc2701fe9be734c4c6d">as_ioctl_params_t::user_addr_start</a></div><div class="ttdeci">as_virtual_address_t user_addr_start</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00099">as_linux_kernel_if.h:99</a></div></div>
<div class="ttc" id="astructas__buffer__obj__s_html"><div class="ttname"><a href="structas__buffer__obj__s.html">as_buffer_obj_s</a></div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00067">as_buffer.h:67</a></div></div>
<div class="ttc" id="aas__cache_8h_html"><div class="ttname"><a href="as__cache_8h.html">as_cache.h</a></div></div>
<div class="ttc" id="aas__memio_8c_html_afc6dfd178448a82b4761ba4c5c0ae368"><div class="ttname"><a href="as__memio_8c.html#afc6dfd178448a82b4761ba4c5c0ae368">as_memio_close</a></div><div class="ttdeci">void as_memio_close(as_memio_file_t *fd)</div><div class="ttdef"><b>Definition:</b> <a href="as__memio_8c_source.html#l00446">as_memio.c:446</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga38bb160b6e30eb5fce6df2e4b4894fad"><div class="ttname"><a href="group__as__reader__writer.html#ga38bb160b6e30eb5fce6df2e4b4894fad">as_reader_writer_set_go</a></div><div class="ttdeci">void as_reader_writer_set_go(as_hardware_address_t base_addr)</div><div class="ttdoc">Starts operation of hardware module.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00128">as_reader_writer.c:128</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga5c0bd52e53c8e68de80b1712c12d9a4a"><div class="ttname"><a href="group__as__reader__writer.html#ga5c0bd52e53c8e68de80b1712c12d9a4a">as_reader_writer_init</a></div><div class="ttdeci">void as_reader_writer_init(as_hardware_address_t base_addr, as_reader_writer_config_t *config)</div><div class="ttdoc">Initializes the hardware module with values provided by config.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00040">as_reader_writer.c:40</a></div></div>
<div class="ttc" id="astructas__buffer__config__s_html_a725038e92e75e1865d74e18ad3840b82"><div class="ttname"><a href="structas__buffer__config__s.html#a725038e92e75e1865d74e18ad3840b82">as_buffer_config_s::type</a></div><div class="ttdeci">as_buffer_type_t type</div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00039">as_buffer.h:39</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_abd2ad4e48be157680906ced537a4b54f"><div class="ttname"><a href="structdevice__data__t.html#abd2ad4e48be157680906ced537a4b54f">device_data_t::address_range_size</a></div><div class="ttdeci">uint32_t address_range_size</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00118">as_driver.h:118</a></div></div>
<div class="ttc" id="agroup__as__reader__writer_html_ga06436c5cb6a63439f2e4b7c14c71fb83"><div class="ttname"><a href="group__as__reader__writer.html#ga06436c5cb6a63439f2e4b7c14c71fb83">as_reader_writer_set_section_size</a></div><div class="ttdeci">void as_reader_writer_set_section_size(as_hardware_address_t base_addr, uint32_t value)</div><div class="ttdoc">Sets the size of a single section in bytes.</div><div class="ttdef"><b>Definition:</b> <a href="as__reader__writer_8c_source.html#l00084">as_reader_writer.c:84</a></div></div>
<div class="ttc" id="agroup__mmap__file__ops_html_ga93a1477871ee8b3e8071b60442a0ceb3"><div class="ttname"><a href="group__mmap__file__ops.html#ga93a1477871ee8b3e8071b60442a0ceb3">as_mmap_start_transfer</a></div><div class="ttdeci">static void as_mmap_start_transfer(as_hardware_address_t module_addr, as_buffer_obj_t *buf, size_t offset, size_t count, AS_BOOL is_write, AS_BOOL cache_management)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00673">as_driver.c:673</a></div></div>
<div class="ttc" id="agroup__as__driver_html_ga79966fb00f8c4921b4d8c5ccc1f75515"><div class="ttname"><a href="group__as__driver.html#ga79966fb00f8c4921b4d8c5ccc1f75515">timer_wq</a></div><div class="ttdeci">static struct work_struct timer_wq</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00086">as_driver.c:86</a></div></div>
<div class="ttc" id="agroup__mmap__file__ops_html_gaeea3980f5b633c4b83ff46b2efc2ea10"><div class="ttname"><a href="group__mmap__file__ops.html#gaeea3980f5b633c4b83ff46b2efc2ea10">driver_as_mmap_write</a></div><div class="ttdeci">static ssize_t driver_as_mmap_write(struct file *filp, const char __user *buffer, size_t count, loff_t *offp)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00856">as_driver.c:856</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_a525ff5655fcedb364e6c17f2db1821a6"><div class="ttname"><a href="structdevice__data__t.html#a525ff5655fcedb364e6c17f2db1821a6">device_data_t::mmap</a></div><div class="ttdeci">mmap_info_t * mmap</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00125">as_driver.h:125</a></div></div>
<div class="ttc" id="astructdevice__info__t_html_a132e36b09251b55e23299b417f50282e"><div class="ttname"><a href="structdevice__info__t.html#a132e36b09251b55e23299b417f50282e">device_info_t::flags</a></div><div class="ttdeci">uint8_t flags</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00050">as_linux_kernel_if.h:50</a></div></div>
<div class="ttc" id="astructas__buffer__config__s_html"><div class="ttname"><a href="structas__buffer__config__s.html">as_buffer_config_s</a></div><div class="ttdef"><b>Definition:</b> <a href="as__buffer_8h_source.html#l00033">as_buffer.h:33</a></div></div>
<div class="ttc" id="agroup__mmap__file__ops_html_gac0196baed6a0a2e62c8c9c3aa2680af4"><div class="ttname"><a href="group__mmap__file__ops.html#gac0196baed6a0a2e62c8c9c3aa2680af4">as_mmap_wait_for_completion</a></div><div class="ttdeci">static void as_mmap_wait_for_completion(int as_mmap_index)</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8c_source.html#l00954">as_driver.c:954</a></div></div>
<div class="ttc" id="aas__linux__kernel__if_8h_html_a2a280719ce4bfe5b91004ba829123ec1"><div class="ttname"><a href="as__linux__kernel__if_8h.html#a2a280719ce4bfe5b91004ba829123ec1">CMD_CREATE_DEVICE</a></div><div class="ttdeci">#define CMD_CREATE_DEVICE</div><div class="ttdef"><b>Definition:</b> <a href="as__linux__kernel__if_8h_source.html#l00078">as_linux_kernel_if.h:78</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga07e09e825f2608339f6213edb9d0c8b3"><div class="ttname"><a href="group__asterics__support.html#ga07e09e825f2608339f6213edb9d0c8b3">as_mutex_unlock</a></div><div class="ttdeci">static void as_mutex_unlock(struct as_mutex_s *mutex)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00533">as_support.h:533</a></div></div>
<div class="ttc" id="astructdevice__data__t_html_aa4368c0149318650e1d18445114ce703"><div class="ttname"><a href="structdevice__data__t.html#aa4368c0149318650e1d18445114ce703">device_data_t::flags</a></div><div class="ttdeci">uint8_t flags</div><div class="ttdef"><b>Definition:</b> <a href="as__driver_8h_source.html#l00078">as_driver.h:78</a></div></div>
<div class="ttc" id="agroup__asterics__support_html_ga57df9331011244df186e877459857341"><div class="ttname"><a href="group__asterics__support.html#ga57df9331011244df186e877459857341">as_mutex_del</a></div><div class="ttdeci">static void as_mutex_del(struct as_mutex_s *mutex)</div><div class="ttdef"><b>Definition:</b> <a href="as__support_8h_source.html#l00530">as_support.h:530</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5815af820a9cc9481f1d0990a0d60286.html">support</a></li><li class="navelem"><a class="el" href="dir_aeec448e7b24a762b5700270b0b15fb8.html">software</a></li><li class="navelem"><a class="el" href="dir_2b4053b170e54e2e3cc8544c22d1fcf0.html">as-linux</a></li><li class="navelem"><a class="el" href="dir_2690676f42af9426abd714c1b1f69bea.html">src</a></li><li class="navelem"><a class="el" href="dir_58290142d4c053075d09782ee63ef28d.html">kernel_module</a></li><li class="navelem"><a class="el" href="dir_aaba335885ccd75864d7a7c2a3ed54c3.html">asterics-driver</a></li><li class="navelem"><a class="el" href="as__driver_8c.html">as_driver.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
